<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"taeyang0126.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":true,"version":"8.22.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":3,"unescape":true,"preload":true}}</script><script src="/js/config.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono.min.css"><meta name="description" content="case  使用 WireMockServer 测试 自定义 WireMockServer12345678910111213141516171819202122232425262728293031323334353637383940public class CustomWireMockServer &#123;    private final WireMockServer mockServer"><meta property="og:type" content="website"><meta property="og:title" content="HttpClient基准测试"><meta property="og:url" content="https://taeyang0126.github.io/_posts/java/HttpClient%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95.html"><meta property="og:site_name" content="WL&#39;s blog"><meta property="og:description" content="case  使用 WireMockServer 测试 自定义 WireMockServer12345678910111213141516171819202122232425262728293031323334353637383940public class CustomWireMockServer &#123;    private final WireMockServer mockServer"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2025-03-15T02:43:22.000Z"><meta property="article:modified_time" content="2025-03-15T02:43:22.000Z"><meta property="article:author" content="WU LEI"><meta property="article:tag" content="JAVA"><meta property="article:tag" content="http client"><meta property="article:tag" content="基准测试"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://taeyang0126.github.io/_posts/java/HttpClient%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":false,"lang":"zh-CN","comments":true,"permalink":"https://taeyang0126.github.io/_posts/java/HttpClient%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95.html","path":"_posts/java/HttpClient基准测试.html","title":"HttpClient基准测试"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>HttpClient基准测试 | WL's blog</title><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="WL's blog" type="application/atom+xml">
</head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">WL's blog</p><i class="logo-line"></i></a></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-folder-open fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-WireMockServer-%E6%B5%8B%E8%AF%95"><span class="nav-number">1.</span> <span class="nav-text">使用 WireMockServer 测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89-WireMockServer"><span class="nav-number">1.1.</span> <span class="nav-text">自定义 WireMockServer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C"><span class="nav-number">1.2.</span> <span class="nav-text">测试结果</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-httpbin-%E6%B5%8B%E8%AF%95"><span class="nav-number">2.</span> <span class="nav-text">使用 httpbin 测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-testcontainers-%E6%9E%84%E5%BB%BA%E9%80%9A%E7%94%A8%E7%9A%84%E6%B5%8B%E8%AF%95%E7%B1%BB"><span class="nav-number">2.1.</span> <span class="nav-text">使用 testcontainers 构建通用的测试类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95"><span class="nav-number">2.2.</span> <span class="nav-text">测试</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="WU LEI" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">WU LEI</p><div class="site-description" itemprop="description">Code & Life</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">58</span> <span class="site-state-item-name">文章</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">24</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">70</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/taeyang0126" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;taeyang0126" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:17674030991@163.com" title="E-Mail → mailto:17674030991@163.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a></span></div><div class="links-of-recent-posts motion-element"><div class="links-of-recent-posts-title"><i class="fa fa-history fa-fw"></i> 最近文章</div><ul class="links-of-recent-posts-list"><li class="links-of-recent-posts-item"><a href="/2025/03/23/jvm/nei-cun-jie-xi/jvm-nei-cun-jie-xi-yuan-kong-jian-she-ji/posts/undefined/" title="2025&#x2F;03&#x2F;23&#x2F;jvm&#x2F;nei-cun-jie-xi&#x2F;jvm-nei-cun-jie-xi-yuan-kong-jian-she-ji&#x2F;posts&#x2F;undefined&#x2F;">JVM内存解析 - 4.JVM 元空间设计</a></li><li class="links-of-recent-posts-item"><a href="/2025/03/23/loom/continuation/posts/undefined/" title="2025&#x2F;03&#x2F;23&#x2F;loom&#x2F;continuation&#x2F;posts&#x2F;undefined&#x2F;">loom-Continuation</a></li><li class="links-of-recent-posts-item"><a href="/2025/03/15/java/httpclient-ji-zhun-ce-shi/posts/undefined/" title="2025&#x2F;03&#x2F;15&#x2F;java&#x2F;httpclient-ji-zhun-ce-shi&#x2F;posts&#x2F;undefined&#x2F;">HttpClient基准测试</a></li><li class="links-of-recent-posts-item"><a href="/2025/03/08/java/jmh-ji-zhun-ce-shi/posts/undefined/" title="2025&#x2F;03&#x2F;08&#x2F;java&#x2F;jmh-ji-zhun-ce-shi&#x2F;posts&#x2F;undefined&#x2F;">JMH基准测试</a></li><li class="links-of-recent-posts-item"><a href="/2025/03/04/jfr/9.jvm-yu-jfr-shi-jian-thread-allocation-statistics/posts/undefined/" title="2025&#x2F;03&#x2F;04&#x2F;jfr&#x2F;9.jvm-yu-jfr-shi-jian-thread-allocation-statistics&#x2F;posts&#x2F;undefined&#x2F;">JVM与JFR事件-Java Application/Statistics/Thread Allocation Statistics</a></li></ul></div></div></div></div></aside></div><div class="main-inner page posts-expand"><div class="post-block" lang="zh-CN"><header class="post-header"><h1 class="post-title" itemprop="name headline">HttpClient基准测试</h1><div class="post-meta-container"><ul class="breadcrumb"><li><a href="/_posts/">_POSTS</a></li><li><a href="/_posts/java/">JAVA</a></li><li>HTTPCLIENT基准测试</li></ul></div></header><div class="post-body"><ul><li><a target="_blank" rel="noopener" href="https://github.com/taeyang0126/JavaForge/tree/main/src/main/java/com/lei/java/forge/http">case</a></li></ul><h2 id="使用-WireMockServer-测试"><a href="#使用-WireMockServer-测试" class="headerlink" title="使用 WireMockServer 测试"></a>使用 WireMockServer 测试</h2><hr><h3 id="自定义-WireMockServer"><a href="#自定义-WireMockServer" class="headerlink" title="自定义 WireMockServer"></a>自定义 WireMockServer</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomWireMockServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WireMockServer mockServer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String url;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomWireMockServer</span><span class="params">(<span class="type">int</span> fixedDelayMs)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">containerThreads</span> <span class="operator">=</span> <span class="number">100</span>; <span class="comment">// 增加容器线程数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">responseThreads</span> <span class="operator">=</span> <span class="number">100</span>;  <span class="comment">// 增加响应线程数</span></span><br><span class="line"></span><br><span class="line">        <span class="type">WireMockConfiguration</span> <span class="variable">options</span> <span class="operator">=</span> WireMockConfiguration.options()</span><br><span class="line">                .port(<span class="number">8080</span>)</span><br><span class="line">                .containerThreads(containerThreads)      <span class="comment">// 增加容器线程数</span></span><br><span class="line">                .jettyAcceptors(<span class="number">4</span>)                       <span class="comment">// 增加接收器数量</span></span><br><span class="line">                .jettyAcceptQueueSize(<span class="number">100</span>)               <span class="comment">// 增加接受队列大小</span></span><br><span class="line">                .asynchronousResponseEnabled(<span class="literal">true</span>)       <span class="comment">// 启用异步响应</span></span><br><span class="line">                .asynchronousResponseThreads(responseThreads); <span class="comment">// 设置异步响应线程数</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.mockServer = <span class="keyword">new</span> <span class="title class_">WireMockServer</span>(options);</span><br><span class="line">        <span class="built_in">this</span>.mockServer.start();</span><br><span class="line"></span><br><span class="line">        mockServer.stubFor(get(urlEqualTo(<span class="string">&quot;/test&quot;</span>))</span><br><span class="line">                .willReturn(aResponse()</span><br><span class="line">                        .withFixedDelay(fixedDelayMs)</span><br><span class="line">                        .withStatus(<span class="number">200</span>)</span><br><span class="line">                        .withBody(<span class="string">&quot;Hello&quot;</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.url = mockServer.baseUrl() + <span class="string">&quot;/test&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUrl</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mockServer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试结果"><a href="#测试结果" class="headerlink" title="测试结果"></a>测试结果</h3><table><thead><tr><th>http client</th><th>测试条件</th><th>测试结果</th><th>说明</th><th>推荐指数</th></tr></thead><tbody><tr><td>jdk11之后提供的 <code>HttpClient</code></td><td>线程数量&#x3D;1<br>单个请求耗时0.1s</td><td>requestCount&#x3D;1000 &#x3D;&gt; <code>0.5s</code><br>requestCount&#x3D;10000 &#x3D;&gt; <code>1.2s</code></td><td>1. 底层使用<code>nio</code><br>2. 在请求数量一定的情况下，总的耗时最少<br>3. 耗时最少的原因是对于每个http请求都会建立一个连接，造成连接极大的浪费<br>4. 会出现大量time_wait连接</td><td>⭐️⭐️⭐️</td></tr><tr><td><code>httpasyncclient</code></td><td>线程数量&#x3D;1<br>单个请求耗时0.1s<br>最大连接数量&#x3D;100</td><td>requestCount&#x3D;1000 &#x3D;&gt; <code>1.2s</code></td><td>1. 底层使用<code>nio</code><br>2. 总耗时与最大连接数量成反比<br>3. 连接数可控且可复用<br>4. 性能与线程数量不正相关</td><td>⭐️⭐️⭐️⭐️⭐</td></tr><tr><td><code>OkHttp</code></td><td>单个请求耗时0.1s</td><td>maxConnection&#x3D;1 &#x3D;&gt; <code>106s</code><br>maxConnection&#x3D;5(default) &#x3D;&gt; <code>21s</code><br>maxConnection&#x3D;100 &#x3D;&gt; <code>1.2s</code></td><td>1. 底层使用<code>bio</code><br>2. 总耗时与最大连接数量成反比<br>3. 每条连接对应一个线程，线程数增长过快</td><td>⭐️⭐</td></tr><tr><td><code>SpringWebflux</code></td><td>线程数量&#x3D;1<br>单个请求耗时0.1s<br>最大连接数量&#x3D;100</td><td>requestCount&#x3D;1000 &#x3D;&gt; <code>1.4s</code></td><td>1. 底层使用<code>reactor</code><br>2. 总耗时与最大连接数量成反比<br>3. 连接数可控且可复用<br>4. 性能与线程数量不正相关</td><td>⭐️⭐️⭐️⭐️⭐</td></tr><tr><td><code>VertxWebClient</code></td><td>线程数量&#x3D;1<br>单个请求耗时0.1s<br>最大连接数量&#x3D;100</td><td>requestCount&#x3D;1000 &#x3D;&gt; <code>1.3s</code></td><td>1. 底层使用<code>netty</code><br>2. 总耗时与最大连接数量成反比<br>3. 连接数可控且可复用<br>4. 性能与线程数量不正相关</td><td>⭐️⭐️⭐️⭐️⭐</td></tr></tbody></table><h2 id="使用-httpbin-测试"><a href="#使用-httpbin-测试" class="headerlink" title="使用 httpbin 测试"></a>使用 httpbin 测试</h2><hr><h3 id="使用-testcontainers-构建通用的测试类"><a href="#使用-testcontainers-构建通用的测试类" class="headerlink" title="使用 testcontainers 构建通用的测试类"></a>使用 testcontainers 构建通用的测试类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Testcontainers</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonMicroServiceTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个私有的 Docker 网络，使得不同的容器可以在这个网络内相互通信。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Network</span> <span class="variable">network</span> <span class="operator">=</span> Network.newNetwork();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">HTTPBIN</span> <span class="operator">=</span> <span class="string">&quot;httpbin&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">HTTPBIN_PORT</span> <span class="operator">=</span> <span class="number">80</span>;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        设置一个 httpbin 容器（它提供各种 HTTP 测试端点）</span></span><br><span class="line"><span class="comment">        暴露 80 端口</span></span><br><span class="line"><span class="comment">        将容器连接到之前创建的网络</span></span><br><span class="line"><span class="comment">        给容器一个网络别名 &quot;httpbin&quot;，使其在网络内可通过该名称访问</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> GenericContainer&lt;?&gt; HTTPBIN_CONTAINER</span><br><span class="line">            = <span class="keyword">new</span> <span class="title class_">GenericContainer</span>&lt;&gt;(<span class="string">&quot;kennethreitz/httpbin:latest&quot;</span>)</span><br><span class="line">            .withExposedPorts(HTTPBIN_PORT)</span><br><span class="line">            .withNetwork(network)</span><br><span class="line">            .withNetworkAliases(HTTPBIN);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;a href=&quot;https://java.testcontainers.org/modules/toxiproxy/&quot;&gt;toxiproxy&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     * 使用 toxiproxy 封装 httpbin</span></span><br><span class="line"><span class="comment">     * 可以使用 toxiproxy 模拟网络故障等情况</span></span><br><span class="line"><span class="comment">     * 可以用的 port 范围是 8666～8697</span></span><br><span class="line"><span class="comment">     * 也连接到同一个网络</span></span><br><span class="line"><span class="comment">     * 一个 TOXIPROXY_CONTAINER 对应多个不同 proxy，通过 TOXIPROXY_CONTAINER.getMappedPort(内部端口) 获取映射到主机的端口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ToxiproxyContainer</span> <span class="variable">TOXIPROXY_CONTAINER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToxiproxyContainer</span>(<span class="string">&quot;ghcr.io/shopify/toxiproxy:2.5.0&quot;</span>)</span><br><span class="line">            .withNetwork(network);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可用的 httpbin 端口</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">GOOD_HTTPBIN_PROXY_PORT</span> <span class="operator">=</span> <span class="number">8666</span>;</span><br><span class="line">    <span class="comment">// READ_TIMEOUT httpbin 端口</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">READ_TIMEOUT_HTTPBIN_PROXY_PORT</span> <span class="operator">=</span> <span class="number">8667</span>;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">RESET_PEER_HTTPBIN_PROXY_PORT</span> <span class="operator">=</span> <span class="number">8668</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String GOOD_HOST;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> GOOD_PORT;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 以下代表请求已经发出到服务端，但是响应超时，或者不能响应（比如服务器重启）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String READ_TIMEOUT_HOST;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> READ_TIMEOUT_PORT;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String RESET_PEER_HOST;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> RESET_PEER_PORT;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 以下代表请求都没有发出去，TCP 链接都没有建立</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONNECT_TIMEOUT_HOST</span> <span class="operator">=</span> <span class="string">&quot;localhost&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 端口 1 一定连不上的</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CONNECT_TIMEOUT_PORT</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">// 不使用 @Container 注解管理容器声明周期，因为我们需要在静态块生成代理，必须在这之前启动容器</span></span><br><span class="line">        <span class="comment">// 不用担心容器不会被关闭，因为 testcontainers 会启动一个 ryuk 容器，用于监控并关闭所有容器</span></span><br><span class="line">        HTTPBIN_CONTAINER.start();</span><br><span class="line">        TOXIPROXY_CONTAINER.start();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ToxiproxyClient</span> <span class="variable">toxiproxyClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToxiproxyClient</span>(TOXIPROXY_CONTAINER.getHost(), TOXIPROXY_CONTAINER.getControlPort());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 1. 创建正常代理</span></span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;all&quot;)</span></span><br><span class="line">            <span class="type">Proxy</span> <span class="variable">proxy</span> <span class="operator">=</span> toxiproxyClient.createProxy(<span class="string">&quot;good&quot;</span>, <span class="string">&quot;0.0.0.0:&quot;</span> + GOOD_HTTPBIN_PROXY_PORT, HTTPBIN + <span class="string">&quot;:&quot;</span> + HTTPBIN_PORT);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. 创建读取超时代理</span></span><br><span class="line">            <span class="comment">// 关闭流量，会 READ TIME OUT</span></span><br><span class="line">            proxy = toxiproxyClient.createProxy(<span class="string">&quot;read_timeout&quot;</span>, <span class="string">&quot;0.0.0.0:&quot;</span> + READ_TIMEOUT_HTTPBIN_PROXY_PORT, HTTPBIN + <span class="string">&quot;:&quot;</span> + HTTPBIN_PORT);</span><br><span class="line">            <span class="comment">// 将上下行带宽设为0，模拟读取超时</span></span><br><span class="line">            <span class="comment">// bandwidth 限制网络连接的带宽</span></span><br><span class="line">            <span class="comment">// UPSTREAM=0 客户端无法向服务端发送请求，导致写超时</span></span><br><span class="line">            <span class="comment">// DOWNSTREAM=0 服务端无法向客户端响应，导致读超时</span></span><br><span class="line">            proxy.toxics().bandwidth(<span class="string">&quot;UP_DISABLE&quot;</span>, ToxicDirection.UPSTREAM, <span class="number">0</span>);</span><br><span class="line">            proxy.toxics().bandwidth(<span class="string">&quot;DOWN_DISABLE&quot;</span>, ToxicDirection.DOWNSTREAM, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3. 创建连接重置代理</span></span><br><span class="line">            <span class="comment">// todo reset peer 不生效，抓包发现没有发送 rst 包，具体原因需要再看</span></span><br><span class="line">            proxy = toxiproxyClient.createProxy(<span class="string">&quot;reset_peer&quot;</span>, <span class="string">&quot;0.0.0.0:&quot;</span> + RESET_PEER_HTTPBIN_PROXY_PORT, HTTPBIN + <span class="string">&quot;:&quot;</span> + HTTPBIN_PORT);</span><br><span class="line">            <span class="comment">// 在连接建立后立即重置连接</span></span><br><span class="line">            <span class="comment">// 上游重置 (ToxicDirection.UPSTREAM): 当客户端尝试向服务器发送数据时，连接会被重置，客户端会收到 &quot;Connection reset by peer&quot; 错误</span></span><br><span class="line">            <span class="comment">// 下游重置 (ToxicDirection.DOWNSTREAM): 当服务器尝试向客户端发送数据时，连接会被重置，服务器会收到 &quot;Connection reset by peer&quot; 错误</span></span><br><span class="line">            <span class="comment">// 延迟为1ms</span></span><br><span class="line">            proxy.toxics().resetPeer(<span class="string">&quot;UP_SLOW_CLOSE&quot;</span>, ToxicDirection.UPSTREAM, <span class="number">1</span>);</span><br><span class="line">            proxy.toxics().resetPeer(<span class="string">&quot;DOWN_SLOW_CLOSE&quot;</span>, ToxicDirection.DOWNSTREAM, <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        GOOD_HOST = TOXIPROXY_CONTAINER.getHost();</span><br><span class="line">        GOOD_PORT = TOXIPROXY_CONTAINER.getMappedPort(GOOD_HTTPBIN_PROXY_PORT);</span><br><span class="line">        READ_TIMEOUT_HOST = TOXIPROXY_CONTAINER.getHost();</span><br><span class="line">        READ_TIMEOUT_PORT = TOXIPROXY_CONTAINER.getMappedPort(READ_TIMEOUT_HTTPBIN_PROXY_PORT);</span><br><span class="line">        RESET_PEER_HOST = TOXIPROXY_CONTAINER.getHost();</span><br><span class="line">        RESET_PEER_PORT = TOXIPROXY_CONTAINER.getMappedPort(RESET_PEER_HTTPBIN_PROXY_PORT);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NetworkTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> OkHttpClient okHttpClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        okHttpClient = <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>.Builder()</span><br><span class="line">                .readTimeout(Duration.ofSeconds(<span class="number">1</span>))</span><br><span class="line">                .writeTimeout(Duration.ofSeconds(<span class="number">1</span>))</span><br><span class="line">                .connectTimeout(Duration.ofSeconds(<span class="number">1</span>))</span><br><span class="line">                .retryOnConnectionFailure(<span class="literal">false</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_good</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        curl(GOOD_HOST, GOOD_PORT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test(expected = ConnectException.class)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_connectTimeout</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        curl(CONNECT_TIMEOUT_HOST, CONNECT_TIMEOUT_PORT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test(expected = SocketTimeoutException.class)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_readTimeout</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        curl(READ_TIMEOUT_HOST, READ_TIMEOUT_PORT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_reset</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        curl(RESET_PEER_HOST, RESET_PEER_PORT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">curl</span><span class="params">(String goodHost, <span class="type">int</span> goodPort)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://&quot;</span> + goodHost + <span class="string">&quot;:&quot;</span> + goodPort + <span class="string">&quot;/delay/0.5&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">                .url(url)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="type">var</span> <span class="variable">res</span> <span class="operator">=</span> okHttpClient</span><br><span class="line">                .newCall(request)</span><br><span class="line">                .execute()</span><br><span class="line">                .body()</span><br><span class="line">                .string();</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;res =&gt; &#123;&#125;&quot;</span>, res);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"></div></div><ul class="breadcrumb"><li><a href="/_posts/">_POSTS</a></li><li><a href="/_posts/java/">JAVA</a></li><li>HTTPCLIENT基准测试</li></ul></div></main><footer class="footer"><div class="footer-inner"><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i> </span><span>站点总字数：</span> <span title="站点总字数">102k</span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span>站点阅读时长 &asymp;</span> <span title="站点阅读时长">6:11</span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><div class="reading-progress-bar"></div><a role="button" class="book-mark-link book-mark-link-fixed"></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/js/third-party/search/local-search.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.3.0/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.4.0/mermaid.min.js","integrity":"sha256-G8ouPAnw4zzMbnAenHnVz6h9XpKbNdOkrqTh7AadyHs="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script src="/js/third-party/pace.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script><script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":false,"archive":false,"delay":true,"timeout":3000,"priority":true,"url":"https://taeyang0126.github.io/_posts/java/HttpClient%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95.html"}</script><script src="/js/third-party/quicklink.js"></script></body></html>