<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>1. Netty Reactor å¯åŠ¨æµç¨‹</title>
    <url>/2025/02/09/1.netty-reactor-qi-dong-liu-cheng/posts/undefined/</url>
    <content><![CDATA[<h2 id="ç›¸å…³é“¾æ¥"><a href="#ç›¸å…³é“¾æ¥" class="headerlink" title="ç›¸å…³é“¾æ¥"></a>ç›¸å…³é“¾æ¥</h2><p><a href="https://zhuanlan.zhihu.com/p/459313682">è¯¦ç»†å›¾è§£Netty Reactorå¯åŠ¨å…¨æµç¨‹ | ä¸‡å­—é•¿æ–‡ | å¤šå›¾é¢„è­¦</a></p>
<p><img data-src="/images/netty_01_01.png" alt="netty"></p>
<h2 id="Netty-æœåŠ¡ç«¯çš„å¯åŠ¨æµç¨‹"><a href="#Netty-æœåŠ¡ç«¯çš„å¯åŠ¨æµç¨‹" class="headerlink" title="Netty æœåŠ¡ç«¯çš„å¯åŠ¨æµç¨‹"></a>Netty æœåŠ¡ç«¯çš„å¯åŠ¨æµç¨‹</h2><ul>
<li>åˆ›å»ºæœåŠ¡ç«¯<code>NioServerSocketChannel</code>å¹¶åˆå§‹åŒ–</li>
<li>å°†æœåŠ¡ç«¯<code>NioServerSocketChannel</code>æ³¨å†Œåˆ°<code>ä¸»Reactorçº¿ç¨‹ç»„</code>ä¸­</li>
<li>æ³¨å†ŒæˆåŠŸåï¼Œå¼€å§‹åˆå§‹åŒ–<code>NioServerSocketChannel</code>ä¸­çš„ pipelineï¼Œç„¶ååœ¨ pipeline ä¸­è§¦å‘ channelRegister äº‹ä»¶ã€‚</li>
<li>éšåç”±<code>NioServerSocketChannel</code>ç»‘å®šç«¯å£åœ°å€ã€‚</li>
<li>ç»‘å®šç«¯å£åœ°å€æˆåŠŸåï¼Œå‘<code>NioServerSocketChannel</code>å¯¹åº”çš„<code>Pipeline</code>ä¸­è§¦å‘ä¼ æ’­<code>ChannelActiveäº‹ä»¶</code>ï¼Œåœ¨<code>ChannelActiveäº‹ä»¶å›è°ƒ</code>ä¸­å‘<code>Main Reactor</code>æ³¨å†Œ<code>OP_ACCEPTäº‹ä»¶</code>ï¼Œå¼€å§‹ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ã€‚æœåŠ¡ç«¯å¯åŠ¨å®Œæˆã€‚</li>
</ul>
<p><img data-src="/images/netty_01_02.png" alt="netty"></p>
<h2 id="1-initAndRegister"><a href="#1-initAndRegister" class="headerlink" title="1. initAndRegister"></a>1. initAndRegister</h2><p><img data-src="/images/netty_01_03.png" alt="netty"></p>
<p>å¼€å§‹æ³¨å†Œ</p>
<p><img data-src="/images/netty_01_04.png" alt="netty"></p>
<h2 id="2-Bind"><a href="#2-Bind" class="headerlink" title="2. Bind"></a>2. Bind</h2><p><code>bindäº‹ä»¶</code>åœ¨ Netty ä¸­è¢«å®šä¹‰ä¸º<code>outboundäº‹ä»¶</code>ï¼Œæ‰€ä»¥å®ƒåœ¨<code>pipeline</code>ä¸­æ˜¯åå‘ä¼ æ’­ã€‚å…ˆä»<code>TailContext</code>å¼€å§‹åå‘ä¼ æ’­ç›´åˆ°<code>HeadContext</code>ï¼›<code>bind</code>çš„æ ¸å¿ƒé€»è¾‘ä¹Ÿæ­£æ˜¯å®ç°åœ¨<code>HeadContext</code>ä¸­</p>
<blockquote>
<p>headContext ä¸­çš„ç»‘å®šæ–¹æ³•</p>
</blockquote>
<p><img data-src="/images/netty_01_05.png" alt="netty"></p>
<blockquote>
<p>NioServerSocketChannel ä¸­çš„ç»‘å®šåŠ¨ä½œ</p>
</blockquote>
<p><img data-src="/images/netty_01_06.png" alt="netty"></p>
<blockquote>
<p>ç»‘å®šå®Œæˆåè§¦å‘ active æ“ä½œ â€“&gt; HeadContext</p>
</blockquote>
<p><img data-src="/images/netty_01_07.png" alt="netty"></p>
<blockquote>
<p>io.netty.channel.AbstractChannel.AbstractUnsafe#beginRead</p>
</blockquote>
<p><img data-src="/images/netty_01_08.png" alt="netty"></p>
<blockquote>
<p>io.netty.channel.nio.AbstractNioChannel#doBeginRead</p>
</blockquote>
<p><img data-src="/images/netty_01_09.png" alt="netty"></p>
<h2 id="ç»†èŠ‚ç‚¹"><a href="#ç»†èŠ‚ç‚¹" class="headerlink" title="ç»†èŠ‚ç‚¹"></a>ç»†èŠ‚ç‚¹</h2><h3 id="Reactorçº¿ç¨‹çš„å¯åŠ¨æ˜¯åœ¨å‘Reactoræäº¤ç¬¬ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡çš„æ—¶å€™å¯åŠ¨çš„"><a href="#Reactorçº¿ç¨‹çš„å¯åŠ¨æ˜¯åœ¨å‘Reactoræäº¤ç¬¬ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡çš„æ—¶å€™å¯åŠ¨çš„" class="headerlink" title="Reactorçº¿ç¨‹çš„å¯åŠ¨æ˜¯åœ¨å‘Reactoræäº¤ç¬¬ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡çš„æ—¶å€™å¯åŠ¨çš„"></a><code>Reactorçº¿ç¨‹</code>çš„å¯åŠ¨æ˜¯åœ¨å‘<code>Reactor</code>æäº¤ç¬¬ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡çš„æ—¶å€™å¯åŠ¨çš„</h3><blockquote>
<p>io.netty.util.concurrent.SingleThreadEventExecutor#execute(java.lang.Runnable, boolean)</p>
</blockquote>
<p><img data-src="/images/netty_01_10.png" alt="netty"></p>
<h3 id="Reactorçº¿ç¨‹çš„æ ¸å¿ƒå·¥ä½œ-è½®è¯¢æ‰€æœ‰æ³¨å†Œå…¶ä¸Šçš„Channelä¸­çš„IOå°±ç»ªäº‹ä»¶ï¼Œå¤„ç†å¯¹åº”Channelä¸Šçš„IOäº‹ä»¶ï¼Œæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡"><a href="#Reactorçº¿ç¨‹çš„æ ¸å¿ƒå·¥ä½œ-è½®è¯¢æ‰€æœ‰æ³¨å†Œå…¶ä¸Šçš„Channelä¸­çš„IOå°±ç»ªäº‹ä»¶ï¼Œå¤„ç†å¯¹åº”Channelä¸Šçš„IOäº‹ä»¶ï¼Œæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡" class="headerlink" title="Reactorçº¿ç¨‹çš„æ ¸å¿ƒå·¥ä½œ è½®è¯¢æ‰€æœ‰æ³¨å†Œå…¶ä¸Šçš„Channelä¸­çš„IOå°±ç»ªäº‹ä»¶ï¼Œå¤„ç†å¯¹åº”Channelä¸Šçš„IOäº‹ä»¶ï¼Œæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡"></a><code>Reactor</code>çº¿ç¨‹çš„æ ¸å¿ƒå·¥ä½œ <code>è½®è¯¢æ‰€æœ‰æ³¨å†Œå…¶ä¸Šçš„Channelä¸­çš„IOå°±ç»ªäº‹ä»¶</code>ï¼Œ<code>å¤„ç†å¯¹åº”Channelä¸Šçš„IOäº‹ä»¶</code>ï¼Œ<code>æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡</code></h3><blockquote>
<p>io.netty.channel.nio.NioEventLoop#run</p>
</blockquote>
<p><img data-src="/images/netty_01_11.png" alt="netty"></p>
<h3 id="Channel-çš„å„ç§äº‹ä»¶è§¦å‘é¡ºåº"><a href="#Channel-çš„å„ç§äº‹ä»¶è§¦å‘é¡ºåº" class="headerlink" title="Channel çš„å„ç§äº‹ä»¶è§¦å‘é¡ºåº"></a>Channel çš„å„ç§äº‹ä»¶è§¦å‘é¡ºåº</h3><ol>
<li><p>handlerAdded</p>
<p> socket å‘ jdk selector æ³¨å†Œåã€åœ¨é€šçŸ¥æ³¨å†Œçš„ promise å®Œæˆä¹‹å‰ï¼ˆä¹Ÿå°±æ˜¯ promise å›è°ƒä¹‹å‰ï¼‰è§¦å‘</p>
<p> <img data-src="/images/netty_01_12.png" alt="netty"></p>
</li>
<li><p>channelRegistered</p>
<p> åœ¨é€šçŸ¥ promise å®Œæˆåï¼ˆä¹Ÿå°±æ˜¯å›è°ƒæ‰§è¡Œå®Œæˆä¹‹åï¼‰ä¼šä¼ æ’­ Registered äº‹ä»¶</p>
<p> <img data-src="/images/netty_01_13.png" alt="netty"></p>
</li>
<li><p>Active </p>
<p>a. æœåŠ¡ç«¯ NioServerSocketChannel åˆ¤æ–­æ˜¯å¦æ¿€æ´»çš„æ ‡å‡†ä¸ºç«¯å£æ˜¯å¦ç»‘å®šæˆåŠŸã€‚</p>
<p>b. </p>
   <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NioServerSocketChannel</span> <span class="keyword">extends</span> <span class="title class_">AbstractNioMessageChannel</span></span><br><span class="line">                             <span class="keyword">implements</span> <span class="title class_">io</span>.netty.channel.socket.ServerSocketChannel &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isActive</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> isOpen() &amp;&amp; javaChannel().socket().isBound();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>c. å®¢æˆ·ç«¯<code>NioSocketChannel</code>åˆ¤æ–­æ˜¯å¦æ¿€æ´»çš„æ ‡å‡†ä¸ºæ˜¯å¦å¤„äº<code>ConnectedçŠ¶æ€</code>ã€‚</p>
<p>d. </p>
   <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isActive</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">SocketChannel</span> <span class="variable">ch</span> <span class="operator">=</span> javaChannel();</span><br><span class="line">    <span class="keyword">return</span> ch.isOpen() &amp;&amp; ch.isConnected();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> e. å‘åä¼ æ’­ active äº‹ä»¶<br> f. <code>readIfIsAutoRead</code></p>
<blockquote>
<p>å¦‚æœå¼€å¯äº†è‡ªåŠ¨è¯»ï¼ˆio.netty.channel.ChannelConfig#isAutoReadï¼‰ï¼Œåˆ™æ³¨å†Œå¯¹åº”æ„Ÿå…´è¶£çš„äº‹ä»¶</p>
</blockquote>
<ul>
<li>server è¿æ¥æ³¨å†Œ OP_ACCEPT äº‹ä»¶</li>
<li>client è¿æ¥æ³¨å†Œ OP_READ äº‹ä»¶</li>
</ul>
</li>
</ol>
<h3 id="å‘åº•å±‚-selector-æ³¨å†Œ"><a href="#å‘åº•å±‚-selector-æ³¨å†Œ" class="headerlink" title="å‘åº•å±‚ selector æ³¨å†Œ"></a>å‘åº•å±‚ selector æ³¨å†Œ</h3><blockquote>
<p>io.netty.channel.nio.AbstractNioChannel#doRegister</p>
</blockquote>
<p><img data-src="/images/netty_01_14.png" alt="netty"></p>
<h3 id="NioServerSocketChannel-æ³¨å†ŒæˆåŠŸåå›è°ƒä»»åŠ¡è¿›è¡Œç«¯å£ç»‘å®šï¼Œä¼šå°†ç«¯å£ç»‘å®šå°è£…ä¸ºä¸€ä¸ªä»»åŠ¡æäº¤åˆ°é˜Ÿåˆ—ä¸­ï¼Œè€Œä¸æ˜¯å³åˆ»æ‰§è¡Œ"><a href="#NioServerSocketChannel-æ³¨å†ŒæˆåŠŸåå›è°ƒä»»åŠ¡è¿›è¡Œç«¯å£ç»‘å®šï¼Œä¼šå°†ç«¯å£ç»‘å®šå°è£…ä¸ºä¸€ä¸ªä»»åŠ¡æäº¤åˆ°é˜Ÿåˆ—ä¸­ï¼Œè€Œä¸æ˜¯å³åˆ»æ‰§è¡Œ" class="headerlink" title="NioServerSocketChannel æ³¨å†ŒæˆåŠŸåå›è°ƒä»»åŠ¡è¿›è¡Œç«¯å£ç»‘å®šï¼Œä¼šå°†ç«¯å£ç»‘å®šå°è£…ä¸ºä¸€ä¸ªä»»åŠ¡æäº¤åˆ°é˜Ÿåˆ—ä¸­ï¼Œè€Œä¸æ˜¯å³åˆ»æ‰§è¡Œ"></a>NioServerSocketChannel æ³¨å†ŒæˆåŠŸåå›è°ƒä»»åŠ¡è¿›è¡Œç«¯å£ç»‘å®šï¼Œä¼šå°†ç«¯å£ç»‘å®šå°è£…ä¸ºä¸€ä¸ªä»»åŠ¡æäº¤åˆ°é˜Ÿåˆ—ä¸­ï¼Œè€Œä¸æ˜¯å³åˆ»æ‰§è¡Œ</h3><p><img data-src="/images/netty_01_15.png" alt="netty"></p>
<h3 id="äº‹ä»¶åœ¨pipelineä¸­çš„ä¼ æ’­"><a href="#äº‹ä»¶åœ¨pipelineä¸­çš„ä¼ æ’­" class="headerlink" title="äº‹ä»¶åœ¨pipelineä¸­çš„ä¼ æ’­"></a>äº‹ä»¶åœ¨<code>pipeline</code>ä¸­çš„ä¼ æ’­</h3><ul>
<li><code>inboundäº‹ä»¶</code>ä»<code>HeadContext</code>å¼€å§‹é€ä¸ªå‘åä¼ æ’­ç›´åˆ°<code>TailContext</code></li>
<li><code>outboundäº‹ä»¶</code>åˆ™æ˜¯åå‘ä¼ æ’­ï¼Œä»<code>TailContext</code>å¼€å§‹åå‘å‘å‰ä¼ æ’­ç›´åˆ°<code>HeadContext</code></li>
</ul>
<p><img data-src="/images/netty_01_16.png" alt="netty"></p>
<h3 id="æœåŠ¡ç«¯-Socket-å’Œå®¢æˆ·ç«¯-Socket-åˆ†åˆ«åœ¨ä½•æ—¶å‘-seletor-æ³¨å†Œæ„Ÿå…´è¶£çš„äº‹ä»¶ï¼Ÿ"><a href="#æœåŠ¡ç«¯-Socket-å’Œå®¢æˆ·ç«¯-Socket-åˆ†åˆ«åœ¨ä½•æ—¶å‘-seletor-æ³¨å†Œæ„Ÿå…´è¶£çš„äº‹ä»¶ï¼Ÿ" class="headerlink" title="æœåŠ¡ç«¯ Socket å’Œå®¢æˆ·ç«¯ Socket åˆ†åˆ«åœ¨ä½•æ—¶å‘ seletor æ³¨å†Œæ„Ÿå…´è¶£çš„äº‹ä»¶ï¼Ÿ"></a>æœåŠ¡ç«¯ Socket å’Œå®¢æˆ·ç«¯ Socket åˆ†åˆ«åœ¨ä½•æ—¶å‘ seletor æ³¨å†Œæ„Ÿå…´è¶£çš„äº‹ä»¶ï¼Ÿ</h3><ul>
<li>æ³¨å†Œæ„Ÿå…´è¶£çš„äº‹ä»¶è§¦å‘æ—¶æœºéƒ½æ˜¯<code>ChannelActive</code><ul>
<li><img data-src="/images/netty_01_17.png" alt="netty"></li>
<li>å¯¹äºæœåŠ¡ç«¯ socket æ¥è¯´ï¼Œbind æˆåŠŸåä¼šä¼ é€’ <code>channelActive</code>äº‹ä»¶</li>
<li>io.netty.channel.AbstractChannel.AbstractUnsafe#bind</li>
<li><img data-src="/images/netty_01_18.png" alt="netty"></li>
<li>å¯¹äºå®¢æˆ·ç«¯ socket æ¥è¯´ï¼Œregister æˆåŠŸåä¼šä¼ é€’ <code>channelActive</code>äº‹ä»¶</li>
<li>io.netty.channel.AbstractChannel.AbstractUnsafe#register0</li>
<li><img data-src="/images/netty_01_19.png" alt="netty"></li>
</ul>
</li>
<li>é€šè¿‡ <code>HeadContext#read</code> æ–¹æ³•è¿›è¡Œæ„Ÿå…´è¶£äº‹ä»¶çš„æ³¨å†Œ</li>
</ul>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">io.netty.channel.AbstractChannel.AbstractUnsafe#beginRead</span><br></pre></td></tr></table></figure></blockquote>
<p><img data-src="/images/netty_01_20.png" alt="netty"></p>
<blockquote>
<p>io.netty.channel.nio.AbstractNioChannel#doBeginRead</p>
</blockquote>
<p><img data-src="/images/netty_01_21.png" alt="netty"></p>
]]></content>
      <categories>
        <category>Netty</category>
      </categories>
      <tags>
        <tag>Netty</tag>
        <tag>æºç è§£æ</tag>
      </tags>
  </entry>
  <entry>
    <title>Arthas</title>
    <url>/2025/02/09/arthas/posts/undefined/</url>
    <content><![CDATA[<ul>
<li><p><a href="https://github.com/alibaba/arthas/issues/71">Arthasçš„ä¸€äº›ç‰¹æ®Šç”¨æ³•æ–‡æ¡£è¯´æ˜ Â· Issue #71 Â· alibaba&#x2F;arthas</a></p>
</li>
<li><p><a href="https://github.com/alibaba/arthas/issues/1424">arthas è·å–springè¢«ä»£ç†çš„ç›®æ ‡å¯¹è±¡ Â· Issue #1424 Â· alibaba&#x2F;arthas</a></p>
</li>
<li><p><a href="https://github.com/alibaba/arthas/issues/537">Arthaså®è·µâ€“jad&#x2F;mc&#x2F;redefineçº¿ä¸Šçƒ­æ›´æ–°ä¸€æ¡é¾™ Â· Issue #537 Â· alibaba&#x2F;arthas</a></p>
</li>
</ul>
<h3 id="1-è·å–å½“å‰HttpServletRequest"><a href="#1-è·å–å½“å‰HttpServletRequest" class="headerlink" title="1. è·å–å½“å‰HttpServletRequest"></a>1. è·å–å½“å‰HttpServletRequest</h3><ul>
<li><p>æ‰§è¡ŒæŸä¸ªrequestæ–¹æ³•</p>
<p>  <code>@org.springframework.web.context.request.RequestContextHolder@currentRequestAttributes().getRequest().xxx</code></p>
</li>
<li><p>è·å–å…¨éƒ¨çš„è¯·æ±‚å¤´</p>
<p>  <code>@org.springframework.web.context.request.RequestContextHolder@currentRequestAttributes().getRequest().getHeaderNames()</code></p>
</li>
</ul>
<h3 id="2-è·å–spring-context-å¹¶æ‰§è¡ŒæŸäº›æ“ä½œ"><a href="#2-è·å–spring-context-å¹¶æ‰§è¡ŒæŸäº›æ“ä½œ" class="headerlink" title="2. è·å–spring context å¹¶æ‰§è¡ŒæŸäº›æ“ä½œ"></a>2. è·å–spring context å¹¶æ‰§è¡ŒæŸäº›æ“ä½œ</h3><blockquote>
<p><strong>å‰ç½®</strong> ä½¿ç”¨ttè®°å½•è¯·æ±‚ï¼Œè·å–åˆ°ä¸Šä¸‹æ–‡</p>
<p>tt -t org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter invokeHandlerMethod -n 3</p>
</blockquote>
<pre><code>tt -i 1000 -w &#39;target.getApplicationContext().getBean(&quot;jdbcTemplate&quot;)&#39;

tt -i 1000 -w &#39;target.getApplicationContext().getBean(&quot;jdbcTemplate&quot;).dataSource.ConnectionPool&#39;

tt -i 1000 -w &#39;target.getApplicationContext().getBean(&quot;jdbcTemplate&quot;).getTargetSource().target&#39;

tt -i 1000 -w &#39;target.getApplicationContext().getBean(&quot;jdbcTemplate&quot;).getTargetSource().target.cacheMap&#39;

tt -i 1000  -w &#39;target.getApplicationContext().getEnvironment().getProperty(&quot;spring.datasource.riskctrl.url&quot;)&#39;
</code></pre>
<h3 id="3-ä½¿ç”¨ognl"><a href="#3-ä½¿ç”¨ognl" class="headerlink" title="3. ä½¿ç”¨ognl"></a>3. ä½¿ç”¨<a href="https://commons.apache.org/dormant/commons-ognl/language-guide.html">ognl</a></h3><ul>
<li><p>å¯¹å‰ç½®è¡¨è¾¾å¼å€¼è¿›è¡ŒäºŒæ¬¡è®¡ç®—  #this è¡¨ç¤ºå‰ç½®è¡¨è¾¾å¼çš„å€¼ <strong><code>.()</code></strong> è¡¨ç¤ºè‡ªè¡¨è¾¾å¼ï¼Œäº§ç”Ÿä¸€ä¸ªå•ä¸€å€¼</p>
<p>  <strong><code>listeners.size().(#this &gt; 100? 2\*#this : 20+#this)</code></strong></p>
</li>
<li><p>å¯¹å‰ç½®è¡¨è¾¾å¼è¿›è¡ŒäºŒæ¬¡è®¡ç®—ï¼Œäº§ç”Ÿä¸€ä¸ªæ•°ç»„</p>
<p>  <strong><code>params[0].&#123;#this == &quot;lei&quot; ?  &quot;yes&quot; : &quot;no&quot;&#125;</code></strong></p>
</li>
<li><p>å¯¹å‰ç½®è¡¨è¾¾å¼(æ•°ç»„ç±»å‹)è¿›è¡ŒäºŒæ¬¡è®¡ç®—ï¼Œäº§ç”Ÿä¸€ä¸ªæ–°çš„æ•°ç»„</p>
<p>  <strong><code>params.&#123;#this instanceof String ?  &quot;yes&quot; : &quot;no&quot;&#125;</code></strong></p>
</li>
<li><p>è¿”å›æ•°ç»„ä¸­ç¬¬ä¸€ä¸ªåŒ¹é…çš„å¯¹è±¡</p>
<p>  <strong><code>params.&#123;^#this instanceof Integer&#125;</code></strong></p>
</li>
<li><p>è°ƒç”¨staticæ–¹æ³• ä½¿ç”¨  <strong>@class@method(<strong><strong>args</strong></strong>)</strong></p>
<p>  <strong><code>@org.springframework.web.context.request.RequestContextHolder@currentRequestAttributes()</code></strong></p>
</li>
<li><p>è·å–é™æ€å­—æ®µ <strong>@class@field</strong></p>
</li>
</ul>
<h3 id="4-ä¸€äº›å¸¸ç”¨å‘½ä»¤"><a href="#4-ä¸€äº›å¸¸ç”¨å‘½ä»¤" class="headerlink" title="4. ä¸€äº›å¸¸ç”¨å‘½ä»¤"></a>4. ä¸€äº›å¸¸ç”¨å‘½ä»¤</h3><ul>
<li><p>è·å–classloader hashï¼Œå¦‚æœæ˜¯springBooté¡¹ç›®å– org.springframework.boot.loader.LaunchedURLClassLoader</p>
<p>  <strong><code>classloader -t</code></strong></p>
</li>
<li><p>å®¹å™¨å®‰è£… vim</p>
<p>  <strong><code>apt-get update &amp;&amp; apt-get install -y vim</code></strong></p>
</li>
<li><p>Ognl è·å–spring context</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 49c2faae è¡¨ç¤ºclassloader hash</span><br><span class="line"># cn.hutool.extra.spring.SpringUtil è¡¨ç¤ºèƒ½è·å–åˆ°springå®¹å™¨çš„æ–¹æ³•</span><br><span class="line">ognl -c 49c2faae &#x27;#beanName=&quot;eventDataAuthManage&quot;, #bean=@cn.hutool.extra.spring.SpringUtil@getBean(#beanName), @org.springframework.aop.support.AopUtils@getTargetClass(#bean).getName()&#x27;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Ognl lambda è¡¨è¾¾å¼</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">-- ä½¿ç”¨ =:[] å®šä¹‰lambdaå³å‡½æ•°</span><br><span class="line">-- ä½¿ç”¨ #getBean() è°ƒç”¨</span><br><span class="line">ognl -c 49c2faae &#x27;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">getBean =:[@cn.hutool.extra.spring.SpringUtil@getBean(#this)],</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">getBean(<span class="string">&quot;syncDataAuthController&quot;</span>).dataCodeList<span class="string">&#x27;</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æŸ¥æ‰¾æ–¹æ³•</p>
<p>  <strong><code>sm com.xx.class</code></strong></p>
</li>
<li><p>ä¿®æ”¹é™æ€å˜é‡çš„å€¼</p>
<p>  <strong><code>getstatic com.xyz.HelloWorld s &quot;#s=&#39;abc&#39;&quot;</code></strong></p>
</li>
<li><p>ä¿®æ”¹å˜é‡çš„å€¼</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">-- 1. ä½¿ç”¨ tt è®°å½•æ–¹æ³•è°ƒç”¨</span><br><span class="line">tt -t com.example.UserService getUserById</span><br><span class="line">-- 2. æŸ¥çœ‹è®°å½•</span><br><span class="line">tt -l</span><br><span class="line">-- 3. ä¿®æ”¹æ•è·çš„å¯¹è±¡ target ä»£è¡¨å½“å‰è¢«è°ƒç”¨æ–¹æ³•çš„å¯¹è±¡å®ä¾‹ï¼ˆå³ &quot;this&quot; å¯¹è±¡ï¼‰</span><br><span class="line">tt -i 1000 -w &#x27;target.name=&quot;newName&quot;&#x27;</span><br></pre></td></tr></table></figure>
</li>
<li><p>è¿‡æ»¤å‚æ•°ç±»å‹ä¸ºclassçš„æ–¹æ³•</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">-- è¿‡æ»¤è¦ç‚¹å°±æ˜¯é€šè¿‡å…¨ç±»å@classæ‹¿åˆ°classå¯¹è±¡ï¼Œå†getName()è·å–åç§°</span><br><span class="line">watch com.wangji92.arthas.plugin.demo.controller.StaticTest invokeClass &#x27;&#123;returnObj,throwExp&#125;&#x27;  -n 5  -x 3  </span><br><span class="line">&#x27;params[0].getName().equals(@com.wangji92.arthas.plug.demo.controller.User@class.getName())&#x27; -v</span><br></pre></td></tr></table></figure>
</li>
<li><p>æŸ¥æ‰¾response404çš„å †æ ˆ</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">stack -E javax.servlet.http.HttpServletResponse sendError|setStatus params[0]==404</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="5-ç‰¹æ®Šå‘½ä»¤"><a href="#5-ç‰¹æ®Šå‘½ä»¤" class="headerlink" title="5. ç‰¹æ®Šå‘½ä»¤"></a>5. ç‰¹æ®Šå‘½ä»¤</h3><ul>
<li><p>Trace å‘½ä»¤å¤šä¸ªç±»ã€å¤šä¸ªæ–¹æ³•ã€æŒ‡å®šçº¿ç¨‹ã€æŒ‡å®šè€—æ—¶æ—¶é—´</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># trace -E è¡¨ç¤ºæ­£åˆ™</span><br><span class="line">trace -E </span><br><span class="line"># è¡¨ç¤ºç±»æ˜¯ NioEventLoop æˆ–è€… SingleThreadEventExecutor</span><br><span class="line">&#x27;io\.netty\.channel\.nio\.NioEventLoop|io\.netty\.util\.concurrent\.SingleThreadEventExecutor&#x27;  </span><br><span class="line"># è¡¨ç¤ºæ–¹æ³•æ˜¯ select processSelectedKeys runAllTasks</span><br><span class="line">&#x27;select|processSelectedKeys|runAllTasks&#x27; </span><br><span class="line"># @Thread arthasæä¾›è¡¨ç¤ºå½“å‰çº¿ç¨‹ #cost arthasæä¾›ï¼Œè¡¨ç¤ºè€—æ—¶</span><br><span class="line">&#x27;@Thread@currentThread().getName().contains(&quot;IO-HTTP-WORKER-IOPool&quot;)&amp;&amp;#cost&gt;500&#x27;</span><br></pre></td></tr></table></figure>
</li>
<li><p>è·å–ä»£ç†å¯¹è±¡çš„åŸå§‹å¯¹è±¡</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tt -w &#x27;#isProxy=:[ @org.springframework.aop.support.AopUtils@isAopProxy(#this)?1: #this instanceof java.lang.reflect.Proxy ? 0 :-1],#isJdkDynamicProxy =:[@org.springframework.aop.support.AopUtils@isJdkDynamicProxy(#this) ? true :false ],#cglibTarget =:[#hField =#this.getClass().getDeclaredField(&quot;CGLIB$CALLBACK_0&quot;),#hField.setAccessible(true),#dynamicAdvisedInterceptor=#hField.get(#this),#fieldAdvised=#dynamicAdvisedInterceptor.getClass().getDeclaredField(&quot;advised&quot;),#fieldAdvised.setAccessible(true),1==1? #fieldAdvised.get(#dynamicAdvisedInterceptor).getTargetSource().getTarget():null],#jdkTarget=:[ #hField=#this.getClass().getSuperclass().getDeclaredField(&quot;h&quot;),#hField.setAccessible(true),#aopProxy=#hField.get(#this),#advisedField=#aopProxy.getClass().getDeclaredField(&quot;advised&quot;),#advisedField.setAccessible(true),1==1?#advisedField.get(#aopProxy).getTargetSource().getTarget():null],#nonProxyResultFunc = :[#proxyResul=#isProxy(#this),#proxyResul== -1 ?#this :#proxyResul== 0? @java.lang.reflect.Proxy@getInvocationHandler(#this):#isJdkDynamicProxy(#this)? #isJdkDynamicProxy(#this) : #cglibTarget(#this)],#nonProxyTarget=#nonProxyResultFunc(target),#nonProxyTarget&#x27;  -x 1 -i 1002</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="6-Vmtool-ä½¿ç”¨"><a href="#6-Vmtool-ä½¿ç”¨" class="headerlink" title="6. Vmtool ä½¿ç”¨"></a>6. Vmtool ä½¿ç”¨</h3><blockquote>
<p><code>vmtool</code> åˆ©ç”¨ Java çš„ Instrumentation API å’Œ JVM TIï¼ˆJVM Tool Interfaceï¼‰ä¸ JVM è¿›è¡Œäº¤äº’ï¼Œå¯ä»¥ç»•è¿‡spring context ç›´æ¥è·å–å¯¹è±¡</p>
</blockquote>
<ul>
<li><p>å¸¸ç”¨å­å‘½ä»¤</p>
<ul>
<li><code>--action getInstances</code>ï¼šè·å–ç±»çš„å®ä¾‹</li>
<li><code>--action forceGc</code>ï¼šå¼ºåˆ¶æ‰§è¡Œåƒåœ¾å›æ”¶</li>
<li><code>--action getClassLoader</code>ï¼šè·å–ç±»åŠ è½½å™¨ä¿¡æ¯</li>
</ul>
</li>
<li><p>com.xxx.cache.CacheAspect ä¸­çš„ boolean å˜é‡ cacheEnabled ä¿®æ”¹ä¸ºfalse</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vmtool: Arthas çš„ä¸€ä¸ªå‘½ä»¤ï¼Œç”¨äºå¯¹ JVM è¿›è¡Œåº•å±‚æ“ä½œã€‚</span><br><span class="line">-x 3: è®¾ç½®æ‰§è¡Œæ¬¡æ•°é™åˆ¶ä¸º 3 æ¬¡ã€‚</span><br><span class="line">--action getInstances: æŒ‡å®šæ“ä½œä¸ºè·å–ç±»çš„å®ä¾‹ã€‚</span><br><span class="line">--className com.xxx.cache.CacheAspect: æŒ‡å®šè¦æ“ä½œçš„ç±»åã€‚</span><br><span class="line">--express: åé¢è·Ÿç€çš„æ˜¯è¦æ‰§è¡Œçš„ OGNL è¡¨è¾¾å¼</span><br><span class="line">onglè¡¨è¾¾å¼:</span><br><span class="line">åå°„è·å–å­—æ®µ #field=instances[0].getClass().getDeclaredField(&quot;cacheEnabled&quot;)</span><br><span class="line">è®¾ç½®ä¸ºtrue #field.setAccessible(true)</span><br><span class="line">ä¿®æ”¹å­—æ®µ #field.set(instances[0],false)</span><br><span class="line"></span><br><span class="line">vmtool -x 3 --action getInstances --className com.xxx.cache.CacheAspect --express &#x27;#field=instances[0].getClass().getDeclaredField(&quot;cacheEnabled&quot;),#field.setAccessible(true),#field.set(instances[0],false)&#x27; -c 3bd94634</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¿®æ”¹finalå˜é‡</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vmtool -x 4 --action getInstances --className com.wangji92.arthas.plugin.demo.controller.CommonController  --express &#x27;#field=instances[0].getClass().getDeclaredField(&quot;FINAL_VALUE&quot;),#modifiers=#field.getClass().getDeclaredField(&quot;modifiers&quot;),#modifiers.setAccessible(true),#modifiers.setInt(#field,#field.getModifiers() &amp; ~@java.lang.reflect.Modifier@FINAL),#field.setAccessible(true),#field.set(instances[0],&quot; 3333&quot;)&#x27; -c  18b4aac2</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ‰§è¡ŒæŸä¸ªæ–¹æ³•</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vmtool -x 1 --action getInstances </span><br><span class="line">--className com.xx.SyncDataAuthController </span><br><span class="line">--express &#x27;instances[0].getDataCodePage(@com.xx.UtilJson@convertValue(&quot;&#123;\&quot;pageIndex\&quot;:0,\&quot;pageSize\&quot;:0&#125;&quot;, @com.xx.BaseQuery@class))&#x27;</span><br><span class="line">-c 49c2faae</span><br></pre></td></tr></table></figure>
</li>
<li><p>è·å–spring context</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vmtool --action getInstances --className org.springframework.context.ConfigurableApplicationContext --express &#x27;instances[0].getEnvironment().getProperty(&quot;server.port&quot;)&#x27;</span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>Arthas</category>
      </categories>
      <tags>
        <tag>Arthas</tag>
        <tag>é—®é¢˜æ’æŸ¥</tag>
      </tags>
  </entry>
  <entry>
    <title>JFR</title>
    <url>/2025/02/09/jfr/posts/undefined/</url>
    <content><![CDATA[<h3 id="å­¦ä¹ èµ„æ–™"><a href="#å­¦ä¹ èµ„æ–™" class="headerlink" title="å­¦ä¹ èµ„æ–™"></a>å­¦ä¹ èµ„æ–™</h3><ul>
<li><a href="https://www.zhihu.com/column/c_1264859821121355776">hashcon JFR å…¨è§£</a></li>
</ul>
<h3 id="JVM-å¯åŠ¨"><a href="#JVM-å¯åŠ¨" class="headerlink" title="JVM å¯åŠ¨"></a>JVM å¯åŠ¨</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Java - XX:StartFlightRecording=delay=6s,disk=<span class="literal">true</span>,dumponexit=<span class="literal">true</span>,filename=/Users/wulei/tmp/recording.jfr,maxsize=1024m,maxage=<span class="number">1d</span>,settings=/Users/wulei/IdeaProjects/personal/op-lei4play/op-samples/jfr/lei-<span class="keyword">default</span>.jfc,path-to-gc-roots=<span class="literal">true</span> -XX:FlightRecorderOptions=repository=/Users/wulei/tmp,stackdepth=<span class="number">64</span> test.Main</span><br></pre></td></tr></table></figure>



<p><code>-XX:StartFlightRecording</code>æœ‰è¿™ä¸ªå‚æ•°å°±ä¼šå¯ç”¨ JFR è®°å½•ï¼Œä»¥ä¸‹æ˜¯ç›¸å…³çš„å‚æ•°</p>
<table>
<thead>
<tr>
<th align="center">é…ç½® key</th>
<th align="left">é»˜è®¤å€¼</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="center">delay</td>
<td align="left">0</td>
<td align="left">å»¶è¿Ÿå¤šä¹…åå¯åŠ¨ JFR è®°å½•ï¼Œæ”¯æŒå¸¦å•ä½é…ç½®ï¼Œ ä¾‹å¦‚ delay&#x3D;60sï¼ˆç§’ï¼‰ï¼Œ delay&#x3D;20mï¼ˆåˆ†é’Ÿï¼‰ï¼Œ delay&#x3D;1hï¼ˆå°æ—¶ï¼‰ï¼Œ delay&#x3D;1dï¼ˆå¤©ï¼‰ï¼Œä¸å¸¦å•ä½å°±æ˜¯ç§’ï¼Œ 0 å°±æ˜¯æ²¡æœ‰å»¶è¿Ÿç›´æ¥å¼€å§‹è®°å½•ã€‚ä¸€èˆ¬ä¸ºäº†é¿å…æ¡†æ¶åˆå§‹åŒ–ç­‰å½±å“ï¼Œæˆ‘ä»¬ä¼šå»¶è¿Ÿ 1 åˆ†é’Ÿå¼€å§‹è®°å½•ï¼ˆä¾‹å¦‚ Spring cloud åº”ç”¨ï¼Œå¯ä»¥çœ‹ä¸‹æ—¥å¿—ä¸­åº”ç”¨å¯åŠ¨è€—æ—¶ï¼Œæ¥å†³å®šä¸‹è¿™ä¸ªæ—¶é—´</td>
</tr>
<tr>
<td align="center">disk</td>
<td align="left">true</td>
<td align="left">æ˜¯å¦å†™å…¥ç£ç›˜ï¼Œglobal buffer æ»¡äº†ä¹‹åï¼Œæ˜¯ç›´æ¥ä¸¢å¼ƒè¿˜æ˜¯å†™å…¥ç£ç›˜æ–‡ä»¶</td>
</tr>
<tr>
<td align="center">dumponexit</td>
<td align="left">false</td>
<td align="left">ç¨‹åºé€€å‡ºæ—¶ï¼Œæ˜¯å¦è¦ dump å‡º ã€‚jfr æ–‡ä»¶</td>
</tr>
<tr>
<td align="center">duration</td>
<td align="left">0</td>
<td align="left">JFR è®°å½•æŒç»­æ—¶é—´ï¼ŒåŒæ ·æ”¯æŒå•ä½é…ç½®ï¼Œä¸å¸¦å•ä½å°±æ˜¯ç§’ï¼Œ0 ä»£è¡¨ä¸é™åˆ¶æŒç»­æ—¶é—´ï¼Œä¸€ç›´è®°å½•</td>
</tr>
<tr>
<td align="center">filename</td>
<td align="left">å¯åŠ¨ç›®å½•&#x2F;hotspot-pid-26732-id-1-2020_03_12_10_07_22.jfrï¼Œpid åé¢å°±æ˜¯ pidï¼Œ id åé¢æ˜¯ç¬¬å‡ ä¸ª JFR è®°å½•ï¼Œå¯ä»¥å¯åŠ¨å¤šä¸ª JFR è®°å½•ã€‚æœ€åå°±æ˜¯æ—¶é—´</td>
<td align="left">dump çš„è¾“å‡ºæ–‡ä»¶</td>
</tr>
<tr>
<td align="center">name</td>
<td align="left">æ— </td>
<td align="left">è®°å½•åç§°ï¼Œç”±äºå¯ä»¥å¯åŠ¨å¤šä¸ª JFR è®°å½•ï¼Œè¿™ä¸ªåç§°ç”¨äºåŒºåˆ†ï¼Œå¦åˆ™åªèƒ½çœ‹åˆ°ä¸€ä¸ªè®°å½• idï¼Œä¸å¥½åŒºåˆ†</td>
</tr>
<tr>
<td align="center">maxage</td>
<td align="left">0</td>
<td align="left">è¿™ä¸ªå‚æ•°åªæœ‰åœ¨ disk ä¸º true çš„æƒ…å†µä¸‹æ‰æœ‰æ•ˆã€‚æœ€å¤§æ–‡ä»¶è®°å½•ä¿å­˜æ—¶é—´ï¼Œå°±æ˜¯ global buffer æ»¡äº†éœ€è¦åˆ·å…¥æœ¬åœ°ä¸´æ—¶ç›®å½•ä¸‹ä¿å­˜ï¼Œè¿™äº›æ–‡ä»¶æœ€å¤šä¿ç•™å¤šä¹…çš„ã€‚ä¹Ÿå¯ä»¥é€šè¿‡å•ä½é…ç½®ï¼Œæ²¡æœ‰å•ä½å°±æ˜¯ç§’ï¼Œé»˜è®¤æ˜¯ 0ï¼Œå°±æ˜¯ä¸é™åˆ¶</td>
</tr>
<tr>
<td align="center">maxsize</td>
<td align="left">250MB</td>
<td align="left">è¿™ä¸ªå‚æ•°åªæœ‰åœ¨ disk ä¸º true çš„æƒ…å†µä¸‹æ‰æœ‰æ•ˆã€‚æœ€å¤§æ–‡ä»¶å¤§å°ï¼Œæ”¯æŒå•ä½é…ç½®ï¼Œ ä¸å¸¦å•ä½æ˜¯å­—èŠ‚ï¼Œm æˆ–è€… M ä»£è¡¨ MBï¼Œg æˆ–è€… G ä»£è¡¨ GBã€‚è®¾ç½®ä¸º 0 ä»£è¡¨ä¸é™åˆ¶å¤§å°**ã€‚è™½ç„¶å®˜ç½‘è¯´é»˜è®¤å°±æ˜¯ 0ï¼Œä½†æ˜¯å®é™…ç”¨çš„æ—¶å€™ï¼Œä¸è®¾ç½®ä¼šæœ‰æç¤º**ï¼š No limit specifiedï¼Œ using maxsize&#x3D;250MB as defaultã€‚ æ³¨æ„ï¼Œè¿™ä¸ªé…ç½®ä¸èƒ½å°äºåé¢å°†ä¼šæåˆ°çš„ maxchunksize è¿™ä¸ªå‚æ•°</td>
</tr>
<tr>
<td align="center">path-to-gc-roots</td>
<td align="left">false</td>
<td align="left">æ˜¯å¦è®°å½• GC æ ¹èŠ‚ç‚¹åˆ°æ´»åŠ¨å¯¹è±¡çš„è·¯å¾„ï¼Œä¸€èˆ¬ä¸æ‰“å¼€è¿™ä¸ªï¼Œé¦–å…ˆè¿™ä¸ªåœ¨æˆ‘ä¸ªäººå®šä½é—®é¢˜çš„æ—¶å€™ï¼Œå¾ˆéš¾ç”¨åˆ°ï¼Œåªè¦ä½ çš„ç¼–ç¨‹ä¹ æƒ¯å¥½ã€‚è¿˜æœ‰å°±æ˜¯æ‰“å¼€è¿™ä¸ªï¼Œæ€§èƒ½æŸè€—æ¯”è¾ƒå¤§ï¼Œä¼šå¯¼è‡´ FullGC ä¸€èˆ¬æ˜¯åœ¨æ€€ç–‘æœ‰å†…å­˜æ³„æ¼çš„æ—¶å€™çƒ­å¯åŠ¨è¿™ç§é‡‡é›†ï¼Œå¹¶ä¸”é€šè¿‡äº§ç”Ÿå¯¹è±¡å †æ ˆæ— æ³•å®šä½çš„æ—¶å€™ï¼ŒåŠ¨æ€æ‰“å¼€å³å¯ã€‚ä¸€èˆ¬é€šè¿‡äº§ç”Ÿè¿™ä¸ªå¯¹è±¡çš„å †æ ˆå°±èƒ½å®šä½ï¼Œå¦‚æœå®šä½ä¸åˆ°ï¼Œæ€€ç–‘æœ‰å…¶ä»–å¼•ç”¨ï¼Œä¾‹å¦‚ ThreadLocal æ²¡æœ‰é‡Šæ”¾è¿™æ ·çš„ï¼Œå¯ä»¥åœ¨ dump çš„æ—¶å€™é‡‡é›† gc roots</td>
</tr>
<tr>
<td align="center">settings</td>
<td align="left">default.jfc</td>
<td align="left">ä½äº <code>$JAVA_HOME/lib/jfr/default.jfc</code>é‡‡é›† Event çš„è¯¦ç»†é…ç½®ï¼Œé‡‡é›†çš„æ¯ä¸ª Event éƒ½æœ‰è‡ªå·±çš„è¯¦ç»†é…ç½®ã€‚å¦ä¸€ä¸ª JDK è‡ªå¸¦çš„é…ç½®æ˜¯ profile.jfcï¼Œä½äº <code>$JAVA_HOME/lib/jfr/profile.jfc</code>å¦‚æœéœ€è¦æŒ‡å®šè‡ªå·±çš„é…ç½®ï¼Œè¿™é‡Œå¯ä»¥è®¾ç½®ä¸ºå…¨è·¯å¾„çš„é…ç½®æ–‡ä»¶ï¼Œç±»ä¼¼ <code>settings=/Users/wulei/tmp/lei-default.jfc</code></td>
</tr>
</tbody></table>
<p><strong><code>-XX:FlightRecorderOptions</code></strong> ç›¸å…³çš„å‚æ•°</p>
<table>
<thead>
<tr>
<th align="left">é…ç½® key</th>
<th align="left">é»˜è®¤å€¼</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="left">allow_threadbuffers_to_disk</td>
<td align="left">false</td>
<td align="left">æ˜¯å¦å…è®¸ åœ¨ thread buffer çº¿ç¨‹é˜»å¡çš„æ—¶å€™ï¼Œç›´æ¥å°† thread buffer çš„å†…å®¹å†™å…¥æ–‡ä»¶ã€‚é»˜è®¤ä¸å¯ç”¨ï¼Œä¸€èˆ¬æ²¡å¿…è¦å¼€å¯è¿™ä¸ªå‚æ•°ï¼Œåªè¦ä½ è®¾ç½®çš„å‚æ•°è®© global buffer å¤§å°åˆç†ä¸è‡³äºåˆ·ç›˜å¾ˆæ…¢ï¼Œå°±è¡Œäº†</td>
</tr>
<tr>
<td align="left">globalbuffersize</td>
<td align="left">å¦‚æœä¸è®¾ç½®ï¼Œæ ¹æ®è®¾ç½®çš„ memorysize è‡ªåŠ¨è®¡ç®—å¾—å‡º</td>
<td align="left">å•ä¸ª global buffer çš„å¤§å°ï¼Œä¸€èˆ¬é€šè¿‡ memorysize è®¾ç½®ï¼Œä¸å»ºè®®è‡ªå·±è®¾ç½®</td>
</tr>
<tr>
<td align="left">maxchunksize</td>
<td align="left">12M</td>
<td align="left">å­˜å…¥ç£ç›˜çš„æ¯ä¸ªä¸´æ—¶æ–‡ä»¶çš„å¤§å°ã€‚é»˜è®¤ä¸º 12MBï¼Œä¸èƒ½å°äº 1Mã€‚å¯ä»¥ç”¨å•ä½é…ç½®ï¼Œä¸å¸¦å•ä½æ˜¯å­—èŠ‚ï¼Œm æˆ–è€… M ä»£è¡¨ MBï¼Œg æˆ–è€… G ä»£è¡¨ GBã€‚æ³¨æ„è¿™ä¸ªå¤§å°æœ€å¥½ä¸è¦æ¯” memorySize å°ï¼Œæ›´ä¸èƒ½æ¯” globalbuffersize å°ï¼Œå¦åˆ™ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™</td>
</tr>
<tr>
<td align="left">memorysize</td>
<td align="left">10M</td>
<td align="left">FR çš„ global buffer å ç”¨çš„æ•´ä½“å†…å­˜å¤§å°ï¼Œä¸€èˆ¬é€šè¿‡è®¾ç½®è¿™ä¸ªå‚æ•°ï¼Œnumglobalbuffers è¿˜æœ‰ globalbuffersize ä¼šè¢«è‡ªåŠ¨è®¡ç®—å‡ºã€‚å¯ä»¥ç”¨å•ä½é…ç½®ï¼Œä¸å¸¦å•ä½æ˜¯å­—èŠ‚ï¼Œm æˆ–è€… M ä»£è¡¨ MBï¼Œg æˆ–è€… G ä»£è¡¨ GB</td>
</tr>
<tr>
<td align="left">numglobalbuffers</td>
<td align="left">å¦‚æœä¸è®¾ç½®ï¼Œæ ¹æ®è®¾ç½®çš„ memorysize è‡ªåŠ¨è®¡ç®—å¾—å‡º</td>
<td align="left">global buffer çš„ä¸ªæ•°ï¼Œä¸€èˆ¬é€šè¿‡ memorysize è®¾ç½®ï¼Œä¸å»ºè®®è‡ªå·±è®¾ç½®</td>
</tr>
<tr>
<td align="left">old-object-queue-size</td>
<td align="left">256</td>
<td align="left">å¯¹äº Profiling ä¸­çš„ Old Object Sample äº‹ä»¶ï¼Œè®°å½•å¤šå°‘ä¸ª Old Objectï¼Œè¿™ä¸ªé…ç½®å¹¶ä¸æ˜¯è¶Šå¤§è¶Šå¥½ã€‚è®°å½•æ˜¯æ€ä¹ˆè®°å½•çš„ï¼Œä¼šåœ¨åé¢çš„å„ç§ Event ä»‹ç»é‡Œé¢è¯¦ç»†ä»‹ç»ã€‚æˆ‘çš„å»ºè®®æ˜¯ï¼Œä¸€èˆ¬åº”ç”¨ 256 å°±å¤Ÿï¼Œæ—¶é—´è·¨åº¦å¤§çš„ï¼Œä¾‹å¦‚ maxage ä¿å­˜äº†ä¸€å‘¨ä»¥ä¸Šçš„ï¼Œå¯ä»¥ç¿»å€</td>
</tr>
<tr>
<td align="left">repository</td>
<td align="left">ç­‰åŒäº -Djava.io.tmpdir æŒ‡å®šçš„ç›®å½•</td>
<td align="left">JFR ä¿å­˜åˆ°ç£ç›˜çš„ä¸´æ—¶è®°å½•çš„ä½ç½®</td>
</tr>
<tr>
<td align="left">retransform</td>
<td align="left">true</td>
<td align="left">æ˜¯å¦é€šè¿‡ JVMTI è½¬æ¢ JFR ç›¸å…³ Event ç±»ï¼Œå¦‚æœè®¾ç½®ä¸º falseï¼Œåˆ™åªåœ¨ Event ç±»åŠ è½½çš„æ—¶å€™æ·»åŠ ç›¸åº”çš„ Java Instrumentationï¼Œè¿™ä¸ªä¸€èˆ¬ä¸ç”¨æ”¹ï¼Œè¿™ç‚¹å†…å­˜ metaspace è¿˜æ˜¯è¶³å¤Ÿçš„</td>
</tr>
<tr>
<td align="left">samplethreads</td>
<td align="left">true</td>
<td align="left">è¿™ä¸ªæ˜¯æ˜¯å¦å¼€å¯çº¿ç¨‹é‡‡é›†çš„çŠ¶æ€ä½é…ç½®ï¼Œåªæœ‰è¿™ä¸ªé…ç½®ä¸º trueï¼Œå¹¶ä¸”åœ¨ Event é…ç½®ä¸­å¼€å¯çº¿ç¨‹ç›¸å…³çš„é‡‡é›†ï¼ˆè¿™ä¸ªåé¢ä¼šæåˆ°ï¼‰ï¼Œæ‰ä¼šé‡‡é›†è¿™äº›äº‹ä»¶</td>
</tr>
<tr>
<td align="left">stackdepth</td>
<td align="left">64</td>
<td align="left">é‡‡é›†äº‹ä»¶å †æ ˆæ·±åº¦ï¼Œæœ‰äº› Event ä¼šé‡‡é›†å †æ ˆï¼Œè¿™ä¸ªå †æ ˆé‡‡é›†çš„æ·±åº¦ï¼Œç»Ÿä¸€ç”±è¿™ä¸ªé…ç½®æŒ‡å®šã€‚æ³¨æ„è¿™ä¸ªå€¼ä¸èƒ½è®¾ç½®è¿‡å¤§ï¼Œå¦‚æœä½ é‡‡é›†çš„ Event ç§ç±»å¾ˆå¤šï¼Œå †æ ˆæ·±åº¦å¤§å¾ˆå½±å“æ€§èƒ½ã€‚æ¯”å¦‚ä½ ç”¨çš„æ˜¯ default.jfc é…ç½®çš„é‡‡é›†ï¼Œå †æ ˆæ·±åº¦ 64 åŸºæœ¬ä¸Šå°±æ˜¯ä¸å½±å“æ€§èƒ½çš„æé™äº†ã€‚ä½ å¯ä»¥è‡ªå®šä¹‰é‡‡é›†æŸäº›äº‹ä»¶ï¼Œå¢åŠ å †æ ˆæ·±åº¦</td>
</tr>
<tr>
<td align="left">threadbuffersize</td>
<td align="left">8KB</td>
<td align="left">threadBuffer å¤§å°ï¼Œæœ€å¥½ä¸è¦ä¿®æ”¹è¿™ä¸ªï¼Œå¦‚æœå¢å¤§ï¼Œé‚£ä¹ˆéšç€ä½ çš„çº¿ç¨‹æ•°å¢å¤šï¼Œå†…å­˜å ç”¨ä¼šå¢å¤§ã€‚è¿‡å°çš„è¯ï¼Œåˆ·å…¥ global buffer çš„æ¬¡æ•°å°±ä¼šå˜å¤šã€‚8KB å°±æ˜¯ç»éªŒä¸­æœ€åˆé€‚çš„</td>
</tr>
</tbody></table>
<h3 id="jcmd-å‘½ä»¤å¯åŠ¨"><a href="#jcmd-å‘½ä»¤å¯åŠ¨" class="headerlink" title="jcmd å‘½ä»¤å¯åŠ¨"></a>jcmd å‘½ä»¤å¯åŠ¨</h3><ul>
<li><strong><code>jcmd &lt;pid&gt; JFR.start</code></strong> å¯åŠ¨ JFR è®°å½•ï¼Œå‚æ•°å’Œ<code>-XX:StartFlightRecording</code>ä¸€æ¨¡ä¸€æ ·ï¼Œè¯·å‚è€ƒä¸Šé¢çš„è¡¨æ ¼ã€‚ä½†æ˜¯æ³¨æ„è¿™é‡Œä¸å†æ˜¯é€—å·åˆ†å‰²ï¼Œè€Œæ˜¯ç©ºæ ¼ç¤ºä¾‹ï¼Œä»£è¡¨å¯åŠ¨ä¸€ä¸ªåç§°ä¸º profile_onlineï¼Œ æœ€å¤šä¿ç•™ä¸€å¤©ï¼Œæœ€å¤§ä¿ç•™ 1G çš„æœ¬åœ°æ–‡ä»¶è®°å½•</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">jcmd 21 JFR.start name=profile_online maxage=1d maxsize=1g</span><br></pre></td></tr></table></figure>

<ul>
<li><strong><code>jcmd &lt;pid&gt; JFR.stop</code></strong> åœæ­¢ JFR è®°å½•ï¼Œéœ€è¦ä¼ å…¥åç§°ï¼Œä¾‹å¦‚å¦‚æœè¦åœæ­¢ä¸Šé¢æ‰“å¼€çš„ï¼Œåˆ™æ‰§è¡Œï¼š</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">jcmd 21 JFR.stop name=profile_online</span><br></pre></td></tr></table></figure>

<ul>
<li><strong><code>jcmd &lt;pid&gt; JFR.check</code></strong> æŸ¥çœ‹å½“å‰æ­£åœ¨æ‰§è¡Œçš„ JFR è®°å½•</li>
<li><strong><code>jcmd &lt;pid&gt; JFR.configure</code></strong> å¦‚æœä¸ä¼ å…¥å‚æ•°ï¼Œåˆ™æ˜¯æŸ¥çœ‹å½“å‰é…ç½®ï¼Œä¼ å…¥å‚æ•°å°±æ˜¯ä¿®æ”¹é…ç½®ã€‚é…ç½®ä¸-XX:FlightRecorderOptions çš„ä¸€æ¨¡ä¸€æ ·ã€‚è¯·å‚è€ƒä¸Šé¢çš„è¡¨æ ¼ ç¤ºä¾‹</li>
<li><strong><code>jcmd &lt;pid&gt; JFR.dump</code></strong> ç”Ÿæˆ jfr æ–‡ä»¶</li>
</ul>
<table>
<thead>
<tr>
<th align="left">å‚æ•°</th>
<th align="left">é»˜è®¤å€¼</th>
<th align="left">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="left">name</td>
<td align="left">æ— </td>
<td align="left">æŒ‡å®šè¦æŸ¥çœ‹çš„ JFR è®°å½•åç§°</td>
</tr>
<tr>
<td align="left">filename</td>
<td align="left">æ— </td>
<td align="left">æŒ‡å®šæ–‡ä»¶è¾“å‡ºä½ç½®</td>
</tr>
<tr>
<td align="left">maxage</td>
<td align="left">0</td>
<td align="left">dump æœ€å¤šçš„æ—¶é—´èŒƒå›´çš„æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡å•ä½é…ç½®ï¼Œæ²¡æœ‰å•ä½å°±æ˜¯ç§’ï¼Œé»˜è®¤æ˜¯ 0ï¼Œå°±æ˜¯ä¸é™åˆ¶</td>
</tr>
<tr>
<td align="left">maxsize</td>
<td align="left">0</td>
<td align="left">dump æœ€å¤§æ–‡ä»¶å¤§å°ï¼Œæ”¯æŒå•ä½é…ç½®ï¼Œ ä¸å¸¦å•ä½æ˜¯å­—èŠ‚ï¼Œm æˆ–è€… M ä»£è¡¨ MBï¼Œg æˆ–è€… G ä»£è¡¨ GBã€‚è®¾ç½®ä¸º 0 ä»£è¡¨ä¸é™åˆ¶å¤§å°</td>
</tr>
<tr>
<td align="left">begin</td>
<td align="left">æ— </td>
<td align="left">dump å¼€å§‹ä½ç½®ï¼Œ å¯ä»¥è¿™ä¹ˆé…ç½®ï¼š09:00ï¼Œ 21:35:00ï¼Œ 2018-06-03T18:12:56.827Zï¼Œ 2018-06-03T20:13:46.832ï¼Œ -10mï¼Œ -3hï¼Œ or -1d</td>
</tr>
<tr>
<td align="left">end</td>
<td align="left">æ— </td>
<td align="left">dump ç»“æŸä½ç½®ï¼Œå¯ä»¥è¿™ä¹ˆé…ç½®ï¼š 09:00ï¼Œ 21:35:00ï¼Œ 2018-06-03T18:12:56.827Zï¼Œ 2018-06-03T20:13:46.832ï¼Œ -10mï¼Œ -3hï¼Œ or -1d ï¼ˆSTRINGï¼Œ no default valueï¼‰</td>
</tr>
<tr>
<td align="left">path-to-gc-roots</td>
<td align="left">false</td>
<td align="left">æ˜¯å¦è®°å½• GC æ ¹èŠ‚ç‚¹åˆ°æ´»åŠ¨å¯¹è±¡çš„è·¯å¾„ï¼Œä¸€èˆ¬ä¸è®°å½•ï¼Œdump çš„æ—¶å€™æ‰“å¼€è¿™ä¸ªè‚¯å®šä¼šè§¦å‘ä¸€æ¬¡ fullGCï¼Œå¯¹çº¿ä¸Šåº”ç”¨æœ‰å½±å“ã€‚æœ€å¥½å‚è€ƒä¹‹å‰å¯¹äº JFR å¯åŠ¨è®°å½•å‚æ•°çš„è¿™ä¸ªå‚æ•°çš„æè¿°ï¼Œè€ƒè™‘æ˜¯å¦æœ‰å¿…è¦</td>
</tr>
</tbody></table>
<h3 id="jfr-é…ç½®æ–‡ä»¶"><a href="#jfr-é…ç½®æ–‡ä»¶" class="headerlink" title="jfr é…ç½®æ–‡ä»¶"></a>jfr é…ç½®æ–‡ä»¶</h3><ul>
<li>openJdk 11.0.22</li>
</ul>
<p> <a href="/files/default.jfc">default.jfc</a> </p>
<p> <a href="/files/profile.jfc">profile.jfc</a> </p>
<ul>
<li>ä¼˜åŒ–åçš„é…ç½®æ–‡ä»¶ï¼ŒåŸºäº openJdk 11.2.22 default.jfrï¼Œæ ¹æ®ğŸ‘‡ğŸ»JFR Event ä¸­çš„å»ºè®®å¯¹äºæŸäº›äº‹ä»¶è¿›è¡Œäº†å…³é—­æˆ–è€…è°ƒæ•´</li>
</ul>
<p> <a href="/files/lei-default.jfc">lei-default.jfc</a> </p>
<h3 id="JFR-Event"><a href="#JFR-Event" class="headerlink" title="JFR Event"></a>JFR Event</h3><ul>
<li><p><a href="https://zhuanlan.zhihu.com/p/124242959">EVENT-1</a></p>
</li>
<li><p><a href="https://zhuanlan.zhihu.com/p/126709861">EVENT-2</a></p>
</li>
<li><p><a href="https://zhuanlan.zhihu.com/p/158592899">EVENT-3</a></p>
</li>
<li><p><a href="https://zhuanlan.zhihu.com/p/158592899">JITç›¸å…³jfräº‹ä»¶</a></p>
</li>
</ul>
<p><img data-src="/images/jfr_01_01.png" alt="img"></p>
]]></content>
      <categories>
        <category>JFR</category>
      </categories>
      <tags>
        <tag>JVM</tag>
        <tag>JFR</tag>
        <tag>ç›‘æ§</tag>
      </tags>
  </entry>
  <entry>
    <title>JVMå†…å­˜ç›¸å…³çš„ç›‘æ§æŒ‡æ ‡</title>
    <url>/2025/02/09/jvm-nei-cun-xiang-guan-de-jian-kong-zhi-biao/posts/undefined/</url>
    <content><![CDATA[<p><img data-src="/images/jvm-memory.PNG" alt="jvmå†…å­˜å›¾ç‰‡"></p>
<h3 id="Heap"><a href="#Heap" class="headerlink" title="Heap"></a>Heap</h3><blockquote>
<p>JVM Heapä»£è¡¨å­˜æ”¾Java Objectsçš„Heap</p>
</blockquote>
<h3 id="Non-Heap"><a href="#Non-Heap" class="headerlink" title="Non-Heap"></a>Non-Heap</h3><h4 id="1-SpringBootçš„JVM-metricsåŸ‹ç‚¹ä»£ç "><a href="#1-SpringBootçš„JVM-metricsåŸ‹ç‚¹ä»£ç " class="headerlink" title="1. SpringBootçš„JVM metricsåŸ‹ç‚¹ä»£ç "></a>1. SpringBootçš„JVM metricsåŸ‹ç‚¹ä»£ç </h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é€šè¿‡io.micrometer.coreå¼•å…¥äº†JVMMemoryuMetricsè¿™ä¸ªåŸ‹ç‚¹å®ç°</span></span><br><span class="line"><span class="keyword">for</span> (MemoryPoolMXBean memoryPoolBean : ManagementFactory.getPlatformMXBeans(MemoryPoolMXBean.class)) &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">area</span> <span class="operator">=</span> MemoryType.HEAP.equals(memoryPoolBean.getType()) ? <span class="string">&quot;heap&quot;</span> : <span class="string">&quot;nonheap&quot;</span>;</span><br><span class="line">    Iterable&lt;Tag&gt; tagsWithId = Tags.concat(tags, <span class="string">&quot;id&quot;</span>, memoryPoolBean.getName(), <span class="string">&quot;area&quot;</span>, area);</span><br><span class="line"></span><br><span class="line">    Gauge.builder(<span class="string">&quot;jvm.memory.used&quot;</span>, memoryPoolBean, (mem) -&gt; getUsageValue(mem, MemoryUsage::getUsed))</span><br><span class="line">        .tags(tagsWithId)</span><br><span class="line">        .description(<span class="string">&quot;The amount of used memory&quot;</span>)</span><br><span class="line">        .baseUnit(BaseUnits.BYTES)</span><br><span class="line">        .register(registry);</span><br><span class="line"></span><br><span class="line">    Gauge</span><br><span class="line">        .builder(<span class="string">&quot;jvm.memory.committed&quot;</span>, memoryPoolBean, (mem) -&gt; getUsageValue(mem, MemoryUsage::getCommitted))</span><br><span class="line">        .tags(tagsWithId)</span><br><span class="line">        .description(<span class="string">&quot;The amount of memory in bytes that is committed for the Java virtual machine to use&quot;</span>)</span><br><span class="line">        .baseUnit(BaseUnits.BYTES)</span><br><span class="line">        .register(registry);</span><br><span class="line"></span><br><span class="line">    Gauge.builder(<span class="string">&quot;jvm.memory.max&quot;</span>, memoryPoolBean, (mem) -&gt; getUsageValue(mem, MemoryUsage::getMax))</span><br><span class="line">        .tags(tagsWithId)</span><br><span class="line">        .description(<span class="string">&quot;The maximum amount of memory in bytes that can be used for memory management&quot;</span>)</span><br><span class="line">        .baseUnit(BaseUnits.BYTES)</span><br><span class="line">        .register(registry);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MemoryPoolMXBeanæ¥å£çš„å®ç°ç±»æ˜¯sun.management.MemoryPoolImplï¼Œè¯¥ç±»é€šè¿‡native methodå¾—åˆ°JVMæä¾›çš„å†…å­˜ä½¿ç”¨ä¿¡æ¯</span></span><br><span class="line"><span class="comment">// Native VM support</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">native</span> MemoryUsage <span class="title function_">getUsage0</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<h4 id="2-JVMæœ¬èº«çš„ä»£ç "><a href="#2-JVMæœ¬èº«çš„ä»£ç " class="headerlink" title="2. JVMæœ¬èº«çš„ä»£ç "></a>2. JVMæœ¬èº«çš„ä»£ç </h4><blockquote>
<p>è®¾ç½®-XX:NativeMemoryTracking&#x3D;summaryæˆ–è€…detailsï¼Œç„¶åä½¿ç”¨jcmdå»æŸ¥çœ‹</p>
</blockquote>
<ul>
<li>CodeCache</li>
<li>Metaspace</li>
<li>CompressedClassSpace</li>
<li>DirectBuffer</li>
<li>Thread Stacks</li>
</ul>
<h3 id="å¸¸è§é—®é¢˜"><a href="#å¸¸è§é—®é¢˜" class="headerlink" title="å¸¸è§é—®é¢˜"></a>å¸¸è§é—®é¢˜</h3><h4 id="1-JVMé‡Œusedå†…å­˜å¾ˆä½ï¼Œä½†æ˜¯å®¹å™¨ç‰©ç†å†…å­˜å ç”¨å¾ˆé«˜"><a href="#1-JVMé‡Œusedå†…å­˜å¾ˆä½ï¼Œä½†æ˜¯å®¹å™¨ç‰©ç†å†…å­˜å ç”¨å¾ˆé«˜" class="headerlink" title="1. JVMé‡Œusedå†…å­˜å¾ˆä½ï¼Œä½†æ˜¯å®¹å™¨ç‰©ç†å†…å­˜å ç”¨å¾ˆé«˜"></a>1. JVMé‡Œusedå†…å­˜å¾ˆä½ï¼Œä½†æ˜¯å®¹å™¨ç‰©ç†å†…å­˜å ç”¨å¾ˆé«˜</h4><p>å› ä¸ºk8sä¸å…è®¸ä½¿ç”¨äº¤æ¢åˆ†åŒºï¼Œæ‰€ä»¥è¿™é‡Œä¸ç”¨è€ƒè™‘å¤–å­˜å’Œå†…å­˜çš„äº¤æ¢å…³ç³»ã€‚</p>
<p>JVMç”³è¯·å†…å­˜çš„æ—¶å€™ï¼Œä¼šé¢„å…ˆä½¿ç”¨<strong>pretouch</strong>çš„æ–¹å¼å£°æ˜å»å‘ŠçŸ¥OSï¼ŒæœŸæœ›ä½¿ç”¨å¤šå°‘sizeçš„å†…å­˜ï¼Œç”±äºç‰©ç†å†…å­˜çš„åˆ†é…ï¼ˆå†…æ ¸æœ¬èº«çš„è™šæ‹Ÿå†…å­˜-ç‰©ç†å†…å­˜ç®¡ç†ï¼‰æ—¶æƒ°æ€§çš„ï¼Œæ‰€ä»¥å£°æ˜è¦ä½¿ç”¨å¤šå°‘sizeï¼Œä¸ä»£è¡¨ç‰©ç†å†…å­˜å°±ç«‹åˆ»åˆ†é…å¤šå°‘ã€‚</p>
<p>æ¯”å¦‚JavaHeapå£°æ˜äº†1Gçš„å†…å­˜éœ€è¦ä½¿ç”¨ï¼Œä½†å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œç‰©ç†å†…å­˜ä¹Ÿæ˜¯é€æ­¥è¢«åˆ†é…çš„ï¼Œç”±äºJavaHeapçš„å†…å­˜è¢«JVMçš„GCç®¡ç†ï¼Œå½“Heapæ»¡æ—¶ï¼ŒJVMçš„GCä¼šå†…éƒ¨é‡Šæ”¾å†…å­˜ç©ºé—´ï¼Œå¾ˆæ˜æ˜¾ï¼ŒGCçš„è¿‡ç¨‹ä¸ä¼šè®©OSæ„ŸçŸ¥ï¼Œä¸ä¼šå»é‡Šæ”¾ç‰©ç†å†…å­˜ï¼Œå‡å¦‚FGCåï¼ŒJavaHeapå®é™…usedçš„å†…å­˜ï¼ˆå¸¸é©»åœ¨JavaHeapï¼‰ä¸­åªæœ‰200Mï¼Œä½†æ­¤æ—¶å®¹å™¨ç‰©ç†å†…å­˜å¾ˆå¯èƒ½æ˜¯1Gå¤šã€‚</p>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>JVM</tag>
        <tag>ç›‘æ§</tag>
        <tag>å†…å­˜</tag>
      </tags>
  </entry>
  <entry>
    <title>JVMé‡è¦å‚æ•°</title>
    <url>/2025/02/09/jvm-chong-yao-can-shu/posts/undefined/</url>
    <content><![CDATA[<h2 id="å¸¸è§„å¯åŠ¨é…ç½®å‚æ•°"><a href="#å¸¸è§„å¯åŠ¨é…ç½®å‚æ•°" class="headerlink" title="å¸¸è§„å¯åŠ¨é…ç½®å‚æ•°"></a>å¸¸è§„å¯åŠ¨é…ç½®å‚æ•°</h2><table>
<thead>
<tr>
<th align="left">å‚æ•°</th>
<th align="left">è¯´æ˜</th>
<th align="left">å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-XX:+PrintFlagsFinal</td>
<td align="left">å¯åŠ¨æ—¶æ‰“å°å‡ºæ‰€æœ‰JVMå‚æ•°</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">-XX:+HeapDumpOnOutOfMemoryError-XX:HeapDumpPath&#x3D;&#x2F;path&#x2F;to&#x2F;heap.hprof-XX:+ExitOnOutOfMemoryError</td>
<td align="left">å¼€å¯OOMæ—¶å †è½¬å‚¨æŒ‡å®šdumpæ–‡ä»¶ä½ç½®å‘ç”Ÿ OOM æ—¶å¼ºåˆ¶ JVM ç«‹å³é€€å‡º</td>
<td align="left">ï¼ï¼dump hprofæ–‡ä»¶æ—¶è¦æ±‚å†…å­˜æ¯”è¾ƒå¤§ï¼Œè¿™å—åç»­è¦å†æ‰¾æ›´å¥½çš„æ–¹æ¡ˆ</td>
</tr>
<tr>
<td align="left">-Xlog:gc*:file&#x3D;gc.log::filecount&#x3D;5,filesize&#x3D;20M</td>
<td align="left">JDK 9+ çš„æ–°ç‰ˆ GC æ—¥å¿—å‚æ•°-Xlog:  gc*                    # è®°å½•æ‰€æœ‰gcç›¸å…³æ—¥å¿—  :file&#x3D;gc.log          # è¾“å‡ºåˆ°gc.logæ–‡ä»¶  :                           # ç©ºçš„tagè¿‡æ»¤å™¨  :filecount&#x3D;5,         # æœ€å¤šä¿ç•™5ä¸ªæ–‡ä»¶  filesize&#x3D;20M          # æ¯ä¸ªæ–‡ä»¶æœ€å¤§20MB</td>
<td align="left">ç­‰ä»·  jdk8           -verbose:gc        -Xloggc:&#x2F;path&#x2F;to&#x2F;gc.log        -XX:+PrintGCDetails        -XX:+PrintGCDateStamps        -XX:+PrintGCTimeStamps        -XX:+UseGCLogFileRotation        -XX:NumberOfGCLogFiles&#x3D;5        -XX:GCLogFileSize&#x3D;20M</td>
</tr>
<tr>
<td align="left">-XX:StartFlightRecording&#x3D;delay&#x3D;1s,disk&#x3D;true,dumponexit&#x3D;true,filename&#x3D;.&#x2F;logs&#x2F;recording.jfr,maxsize&#x3D;1024m,maxage&#x3D;1d,path-to-gc-roots&#x3D;true-XX:FlightRecorderOptions&#x3D;stackdepth&#x3D;128</td>
<td align="left">jfrå¯åŠ¨å‚æ•°ï¼Œå…·ä½“å‚è€ƒ <a href="https://rq3nt70g815.feishu.cn/wiki/CtdmwY0yPiUkgKkXidecur63nVc">JFR</a></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">-Xlog:safepoint&#x3D;debug:file&#x3D;.&#x2F;logs&#x2F;safepoint.log:utctime,level,tags:filecount&#x3D;50,filesize&#x3D;100M</td>
<td align="left">safepoint</td>
<td align="left"></td>
</tr>
</tbody></table>
<p><img data-src="data:image/jpeg;base64,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" alt="123"></p>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>JVM</tag>
        <tag>å‚æ•°</tag>
      </tags>
  </entry>
  <entry>
    <title>Socket</title>
    <url>/2025/02/09/socket/posts/undefined/</url>
    <content><![CDATA[<ul>
<li><a href="https://zhuanlan.zhihu.com/p/455352339">èŠèŠNettyé‚£äº›äº‹å„¿ä¹‹ä»å†…æ ¸è§’åº¦çœ‹IOæ¨¡å‹</a></li>
</ul>
<h3 id="Socket-æ•°æ®æ¥æ”¶åˆ°-Epoll-å¤„ç†æµç¨‹"><a href="#Socket-æ•°æ®æ¥æ”¶åˆ°-Epoll-å¤„ç†æµç¨‹" class="headerlink" title="Socket æ•°æ®æ¥æ”¶åˆ° Epoll å¤„ç†æµç¨‹"></a>Socket æ•°æ®æ¥æ”¶åˆ° Epoll å¤„ç†æµç¨‹</h3><pre>
<code class="mermaid">

sequenceDiagram
    participant S as Socket
    participant WQ as Wait Queue
    participant CB as Callback (ep_poll_callback)
    participant EP as eppoll_entry
    participant EI as epitem
    participant EPL as eventpoll

    S-&gt;&gt;S: æ¥æ”¶æ•°æ®
    S-&gt;&gt;WQ: è§¦å‘ç­‰å¾…é˜Ÿåˆ—
    WQ-&gt;&gt;CB: è°ƒç”¨å›è°ƒå‡½æ•°
    CB-&gt;&gt;EP: container_of æ‰¾åˆ° eppoll_entry
    EP-&gt;&gt;EI: è®¿é—® base æŒ‡é’ˆæ‰¾åˆ° epitem
    EI-&gt;&gt;EPL: å°† epitem åŠ å…¥æ´»è·ƒé˜Ÿåˆ—
</code>
</pre>


<ol>
<li><p>æ•°æ®åˆ°è¾¾å’Œåˆå§‹å¤„ç†ï¼š </p>
<ul>
<li>ç½‘å¡æ¥æ”¶æ•°æ®ï¼Œé€šè¿‡ DMA å°†æ•°æ®æ”¾å…¥ Ring Bufferã€‚</li>
<li>è§¦å‘è½¯ä¸­æ–­ï¼Œå†…æ ¸å°†æ•°æ®åŒ…ï¼ˆsk_buffï¼‰æ”¾å…¥ socket çš„æ¥æ”¶é˜Ÿåˆ—ã€‚</li>
</ul>
</li>
<li><p>Socket å”¤é†’ç­‰å¾…é˜Ÿåˆ—ï¼š </p>
<ul>
<li>Socket æ£€æµ‹åˆ°æœ‰æ–°æ•°æ®ï¼Œå¼€å§‹å”¤é†’å…¶ç­‰å¾…é˜Ÿåˆ—ï¼ˆwait_queueï¼‰ä¸­çš„ç­‰å¾…è€…ã€‚</li>
<li>è·å–å…¶ä¸­ä¸€ä¸ª wait_queue_entry_tï¼Œè¿™é‡Œä¸è·å–å…¨éƒ¨ä¸€æ˜¯é¿å…æƒŠç¾¤æ•ˆåº”ï¼ŒäºŒæ˜¯ epoll åœºæ™¯ä¸‹ä¸€èˆ¬ä¹Ÿåªä¼šæœ‰ä¸€ä¸ª wait_queue_entry_t</li>
</ul>
</li>
<li><p>å›è°ƒå‡½æ•°è§¦å‘ï¼š </p>
<ul>
<li>å¯¹äº epoll æ·»åŠ çš„ç­‰å¾…é¡¹ï¼Œå…¶ wait_queue_entry_t çš„å›è°ƒå‡½æ•°æ˜¯ ep_poll_callbackã€‚</li>
<li>å†…æ ¸è°ƒç”¨è¿™ä¸ªå›è°ƒå‡½æ•°ï¼Œä¼ å…¥ wait_queue_entry_t æŒ‡é’ˆä½œä¸ºå‚æ•°ã€‚</li>
</ul>
</li>
<li><p>æ‰¾åˆ° eppoll_entryï¼š </p>
<ul>
<li>åœ¨ ep_poll_callback å‡½æ•°ä¸­ï¼Œä½¿ç”¨ container_of å®ã€‚</li>
<li>é€šè¿‡ wait_queue_entry_t æŒ‡é’ˆï¼Œæ‰¾åˆ°åŒ…å«å®ƒçš„ eppoll_entry ç»“æ„ã€‚</li>
</ul>
 <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">eppoll_entry</span> *<span class="title">pwq</span> =</span> container_of(wait, <span class="keyword">struct</span> eppoll_entry, wait);</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä» eppoll_entry åˆ° epitemï¼š </p>
<ul>
<li>eppoll_entry ç»“æ„ä¸­æœ‰ä¸€ä¸ª base æŒ‡é’ˆï¼Œç›´æ¥æŒ‡å‘å…³è”çš„ epitemã€‚</li>
</ul>
 <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epitem</span> *<span class="title">epi</span> =</span> pwq-&gt;base;</span><br></pre></td></tr></table></figure>
</li>
<li><p>è·å– eventpoll ç»“æ„ï¼š </p>
<ul>
<li>epitem ç»“æ„ä¸­åŒ…å«æŒ‡å‘å…¶å…³è”çš„ eventpoll ç»“æ„çš„æŒ‡é’ˆã€‚</li>
</ul>
 <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">eventpoll</span> *<span class="title">ep</span> =</span> epi-&gt;ep;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å°† epitem åŠ å…¥æ´»è·ƒé˜Ÿåˆ—ï¼š </p>
<ul>
<li>æ£€æŸ¥ epitem æ˜¯å¦å·²ç»åœ¨æ´»è·ƒé˜Ÿåˆ—ä¸­ã€‚</li>
<li>å¦‚æœä¸åœ¨ï¼Œåˆ™å°†å…¶æ·»åŠ åˆ° eventpoll çš„æ´»è·ƒé˜Ÿåˆ—ï¼ˆrdllistï¼‰ä¸­ã€‚</li>
</ul>
 <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!ep_is_linked(&amp;epi-&gt;rdllink))</span><br><span class="line">    list_add_tail(&amp;epi-&gt;rdllink, &amp;ep-&gt;rdllist);</span><br></pre></td></tr></table></figure>
</li>
<li><p>å”¤é†’ç­‰å¾…çš„è¿›ç¨‹ï¼š </p>
<ul>
<li>å¦‚æœæœ‰è¿›ç¨‹æ­£åœ¨ç­‰å¾… epoll äº‹ä»¶ï¼ˆé€šè¿‡ epoll_waitï¼‰ï¼Œå”¤é†’å®ƒã€‚</li>
</ul>
</li>
</ol>
]]></content>
      <categories>
        <category>ç½‘ç»œ</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>ç½‘ç»œ</tag>
        <tag>socket</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Cloud Gateway</title>
    <url>/2025/02/09/spring-cloud-gateway/posts/undefined/</url>
    <content><![CDATA[<h2 id="é‡è¦å±æ€§"><a href="#é‡è¦å±æ€§" class="headerlink" title="é‡è¦å±æ€§"></a>é‡è¦å±æ€§</h2><ol>
<li>GATEWAY_ORIGINAL_REQUEST_URL_ATTR</li>
</ol>
<ul>
<li>è®°å½•åŸå§‹çš„urlè¯·æ±‚</li>
<li>é”™è¯¯é‡è¯•æ—¶å¯ä»¥ç”¨åŸå§‹URIé‡è¯•</li>
<li>å¯ä»¥è®°å½•å®Œæ•´çš„è¯·æ±‚è½¬æ¢é“¾è·¯</li>
<li>æ•…éšœåˆ†ææ—¶å¯ä»¥çŸ¥é“è¯·æ±‚çš„æ¥æº</li>
<li>åœ¨è·¯ç”±é‡å†™æ—¶éœ€è¦æ›´æ–°æ­¤å±æ€§</li>
</ul>
<ol start="2">
<li>GATEWAY_REQUEST_URL_ATTR</li>
</ol>
<ul>
<li>å­˜å‚¨è¯·æ±‚å°†è¦è½¬å‘çš„ç›®æ ‡URL</li>
<li>åç»­çš„è¿‡æ»¤å™¨å’Œè·¯ç”±å¯ä»¥é€šè¿‡è¿™ä¸ªå±æ€§çŸ¥é“è¯·æ±‚è¦è¢«è½¬å‘åˆ°å“ªé‡Œ</li>
<li>åœ¨è·¯ç”±é‡å†™æ—¶éœ€è¦æ›´æ–°æ­¤å±æ€§</li>
</ul>
<ol start="3">
<li>PRESERVE_HOST_HEADER_ATTRIBUTE</li>
</ol>
<ul>
<li>æ§åˆ¶æ˜¯å¦ä¿ç•™åŸå§‹è¯·æ±‚çš„ Host å¤´</li>
<li>true: è½¬å‘è¯·æ±‚æ—¶ä¼šä¿ç•™å®¢æˆ·ç«¯çš„åŸå§‹ Host header</li>
<li>false: ä¼šä½¿ç”¨ç›®æ ‡æœåŠ¡çš„ Host</li>
<li>ä½¿ç”¨åœºæ™¯ï¼šå‡è®¾è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨ä¿®æ”¹äº†hostå±æ€§ï¼Œå¦‚æœæ²¡æœ‰å¼€å¯æ­¤é…ç½®ï¼Œé‚£ä¹ˆåç»­çš„å¤„ç†å¯èƒ½å½±å“æ­¤å±æ€§ï¼Œè¿™æ—¶å€™éœ€è¦å¼€å¯æ­¤é…ç½®</li>
</ul>
<h2 id="é‡è¦è¿‡æ»¤å™¨"><a href="#é‡è¦è¿‡æ»¤å™¨" class="headerlink" title="é‡è¦è¿‡æ»¤å™¨"></a>é‡è¦è¿‡æ»¤å™¨</h2><ol>
<li><p>RetryGatewayFilterFactory</p>
<blockquote>
<p>é‡è¯•è¿‡æ»¤å™¨</p>
</blockquote>
 <figure class="highlight java"><table><tr><td class="code"><pre><span class="line">- name: Retry #é‡è¯•ç­–ç•¥:ç›®å‰åªå¯¹æä¾›è€…ä¸‹çº¿å¯¼è‡´çš„è¿æ¥å¼‚å¸¸é‡è¯•ï¼Œéœ€æŒç»­è§‚å¯Ÿå¼‚å¸¸æƒ…å†µ</span><br><span class="line">  args: </span><br><span class="line">    retries: <span class="number">1</span></span><br><span class="line">    series: #ä¸å¯¹httpçŠ¶æ€æ¥åˆ¤æ–­æ˜¯å¦è¿›è¡Œé‡è¯•</span><br><span class="line">    exceptions: io.netty.channel.AbstractChannel$AnnotatedConnectException</span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>ç½‘å…³</category>
      </categories>
      <tags>
        <tag>ç½‘å…³</tag>
        <tag>spring cloud gateway</tag>
        <tag>spring cloud</tag>
      </tags>
  </entry>
  <entry>
    <title>TCP è¿æ¥</title>
    <url>/2025/02/09/tcp-lian-jie/posts/undefined/</url>
    <content><![CDATA[<h3 id="TCP-çŠ¶æ€è½¬æ¢å›¾"><a href="#TCP-çŠ¶æ€è½¬æ¢å›¾" class="headerlink" title="TCP çŠ¶æ€è½¬æ¢å›¾"></a>TCP çŠ¶æ€è½¬æ¢å›¾</h3><p><img data-src="/images/tcp_01_01.png" alt="img"></p>
<h3 id="TCP-è¿æ¥çš„åˆ†ç»„äº¤æ¢"><a href="#TCP-è¿æ¥çš„åˆ†ç»„äº¤æ¢" class="headerlink" title="TCP è¿æ¥çš„åˆ†ç»„äº¤æ¢"></a>TCP è¿æ¥çš„åˆ†ç»„äº¤æ¢</h3><p><img data-src="/images/tcp_01_02.png" alt="img"></p>
<ul>
<li>MSSï¼ˆMaximum Segment Sizeï¼‰: æŒ‡å®šäº† TCP æ•°æ®åŒ…ä¸­æ•°æ®éƒ¨åˆ†çš„æœ€å¤§é•¿åº¦<ul>
<li>ä¸€èˆ¬çº¦å®šæœ€å°æ˜¯ 536ï¼Œå› ä¸º IPv4 è§„èŒƒä¸­å»ºè®®çš„æœ€å° MTU æ˜¯ 576ï¼Œå‡å» 20 å­—èŠ‚çš„æ ‡å‡† IPv4 å¤´çš„é•¿åº¦ï¼Œå†å‡å» 20 å­—èŠ‚çš„æ ‡å‡† TCP å¤´çš„é•¿åº¦ï¼Œå¾—åˆ° 536 å­—èŠ‚</li>
<li>ä¸€èˆ¬çº¦å®šæœ€å¤§æ˜¯ 1460ï¼Œå› ä¸º IPv4 è§„èŒƒä¸­å»ºè®®çš„æœ€å¤§ MTU æ˜¯ 1500</li>
</ul>
</li>
<li>MSS ä»¥åŒæ–¹çº¦å®šçš„æœ€å°å€¼ä¸ºå‡†</li>
<li>è¯·æ±‚ ACK æ˜¯æœåŠ¡ç«¯å¯¹å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„æ•°æ®åŒ…çš„å“åº”</li>
<li>åº”ç­” ACK æ˜¯å®¢æˆ·ç«¯å¯¹æœåŠ¡ç«¯å‘é€è¿‡æ¥çš„æ•°æ®åŒ…çš„å“åº”</li>
<li>TIME_WAIT çŠ¶æ€<ul>
<li>ä¸»åŠ¨å…³é—­çš„é‚£ç«¯ç»å†äº†è¿™ä¸ªçŠ¶æ€</li>
<li>æ­¤çŠ¶æ€çš„æŒç»­æ—¶é—´æœ€é•¿æ˜¯ 2MSLï¼ŒMSL åœ¨ RFC 1122 çš„å»ºè®®å€¼æ˜¯ 2 åˆ†é’Ÿï¼Œåœ¨ Berkeley ä¿®æ”¹ä¸º 30sï¼Œæ„å‘³ç€ TIME_WAIT çŠ¶æ€çš„æŒç»­æ—¶é—´åœ¨ 1 åˆ†é’Ÿåˆ° 4 åˆ†é’Ÿä¹‹é—´<ul>
<li>MSL æ˜¯ä»»ä½• IP æ•°æ®æŠ¥èƒ½å­˜æ´»çš„æœ€é•¿æ—¶é—´ï¼Œå› ä¸ºæ¯ä¸ªæ•°æ®æŠ¥éƒ½æœ‰è·³é™ï¼ˆhop limitï¼‰ï¼Œæœ€å¤§æ˜¯ 255 è·³</li>
</ul>
</li>
<li>æ­¤çŠ¶æ€å­˜åœ¨çš„ç†ç”±<ul>
<li>å¯é çš„å®ç° TCP å…¨åŒå·¥è¿æ¥çš„ç»ˆæ­¢</li>
<li>è¢«åŠ¨ç»ˆæ­¢çš„ä¸€æ–¹ä¼šå‘é€æœ€ç»ˆçš„ FINï¼Œå› æ­¤æ­¤ç«¯å¿…é¡»ç»´æŠ¤çŠ¶æ€ä¿¡æ¯ï¼Œä»¥å…è®¸æ­¤ç«¯é‡æ–°å‘é€æœ€ç»ˆçš„ ACKã€‚å¦‚æœæ­¤ç«¯ä¸ç»´æŠ¤çŠ¶æ€ä¿¡æ¯äº†ï¼Œé‚£ä¹ˆä¼šå“åº”ä¸€ä¸ª <strong>RST</strong>ï¼Œä¼šè¢«å¯¹ç«¯è§£é‡Šä¸ºä¸€ä¸ªé”™è¯¯</li>
<li>å…è®¸è€çš„é‡å¤åˆ†èŠ‚åœ¨ç½‘ç»œä¸­æ¶ˆé€</li>
<li>å‡è®¾æŸä¸ªè¿æ¥å…³é—­äº†ï¼Œç„¶ååœ¨ç›¸åŒçš„å®¢æˆ·ç«¯ã€æœåŠ¡å™¨ä¹‹é—´å»ºç«‹çš„ä¸€ä¸ªæ–°çš„è¿æ¥ï¼Œè¿™ä¸ªè¿æ¥çš„å››å…ƒç»„ä¸ä¹‹å‰å…³é—­çš„è¿æ¥å®Œå…¨ä¸€è‡´ï¼Œåä¸€ä¸ªè¿æ¥ç§°ä¸ºå‰ä¸€ä¸ªè¿æ¥çš„åŒ–èº«ã€‚TCP å¿…é¡»é˜²æ­¢æ¥è‡ªæŸä¸ªè¿æ¥çš„è€çš„é‡å¤åˆ†ç»„åœ¨è¯¥è¿æ¥å·²ç»ˆæ­¢åå†ç°ï¼Œä»è€Œè¢«è¯¯è§£æˆå±äºåŒä¸€ä¸ªè¿æ¥çš„æŸä¸ªæ–°çš„åŒ–èº«ã€‚ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼ŒTCP å°†ä¸ç»™å¤„äº TIME_WAIT çŠ¶æ€çš„è¿æ¥å‘èµ·æ–°çš„åŒ–èº«ã€‚åˆå› ä¸º TIME_WAIT æœ€é•¿å­˜æ´»æ—¶é—´ä¸º 2MSLï¼Œæ­¤æ—¶é—´è¶³å¤Ÿæ—§è¿æ¥çš„æ•°æ®åŒ…æ¶ˆé€äº†</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="Listen"><a href="#Listen" class="headerlink" title="Listen"></a>Listen</h3><blockquote>
<p>æœ€ä¸»è¦çš„å·¥ä½œå°±æ˜¯<code>ç”³è¯·å’Œåˆå§‹åŒ–</code>æ¥æ”¶é˜Ÿåˆ—ï¼ŒåŒ…æ‹¬<code>å…¨è¿æ¥é˜Ÿåˆ—ä»¥åŠåŠè¿æ¥é˜Ÿåˆ—</code></p>
</blockquote>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// fdã€backlog</span></span><br><span class="line">listen(fd, <span class="number">128</span>)</span><br></pre></td></tr></table></figure>

<h4 id="å…¨è¿æ¥é˜Ÿåˆ—"><a href="#å…¨è¿æ¥é˜Ÿåˆ—" class="headerlink" title="å…¨è¿æ¥é˜Ÿåˆ—"></a>å…¨è¿æ¥é˜Ÿåˆ—</h4><blockquote>
<p>å…¨è¿æ¥é˜Ÿåˆ—æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œå†…æ ¸ä¸­ä½¿ç”¨é“¾è¡¨çš„ headã€tailï¼Œæ–¹ä¾¿åº”ç”¨å±‚ç›´æ¥æ ¹æ®å¤´å°¾æŒ‡é’ˆæŸ¥æ‰¾æ¥å…¥çš„è¿æ¥</p>
</blockquote>
<h5 id="å…¨è¿æ¥é˜Ÿåˆ—çš„é•¿åº¦"><a href="#å…¨è¿æ¥é˜Ÿåˆ—çš„é•¿åº¦" class="headerlink" title="å…¨è¿æ¥é˜Ÿåˆ—çš„é•¿åº¦"></a>å…¨è¿æ¥é˜Ÿåˆ—çš„é•¿åº¦</h5><ul>
<li>æœ€å¤§é•¿åº¦æ˜¯ listen ä¼ å…¥çš„ backlog å’Œ net.core.somaxconn ä¹‹é—´è¾ƒå°çš„å€¼ã€‚å¦‚æœéœ€è¦åŠ å¤§é•¿åº¦ï¼Œéœ€è¦è°ƒæ•´è¿™ä¸¤ä¸ªå€¼ã€‚</li>
<li>ä½¿ç”¨ <code>cat /proc/sys/net/core/somaxconn</code> å‘½ä»¤æŸ¥çœ‹</li>
<li>æŸ¥çœ‹æŸä¸ªè¿›ç¨‹çš„å…¨è¿æ¥é˜Ÿåˆ—çš„é•¿åº¦ï¼Œé€šè¿‡ä½¿ç”¨å‘½ä»¤ **<code>ss -nlt</code>**è¿›è¡ŒæŸ¥çœ‹ï¼Œå…¶ä¸­ <strong>Send-Q</strong> è¡¨ç¤ºå…¨è¿æ¥é˜Ÿåˆ—é•¿åº¦</li>
</ul>
<p><img data-src="/images/tcp_01_03.png" alt="img"></p>
<h5 id="åˆ¤æ–­å…¨è¿æ¥é˜Ÿåˆ—æ˜¯å¦æº¢å‡º"><a href="#åˆ¤æ–­å…¨è¿æ¥é˜Ÿåˆ—æ˜¯å¦æº¢å‡º" class="headerlink" title="åˆ¤æ–­å…¨è¿æ¥é˜Ÿåˆ—æ˜¯å¦æº¢å‡º"></a>åˆ¤æ–­å…¨è¿æ¥é˜Ÿåˆ—æ˜¯å¦æº¢å‡º</h5><p><strong><code>watch &#39;netstat -s | grep overflowed&#39;</code></strong></p>
<p>å¦‚æœä¸Šè¿°å‘½ä»¤ç»“æœæ˜¾ç¤º <strong>xx times the listen queue of a socket overflowed</strong> åˆ™è¯´æ˜æœ‰å…¨è¿æ¥é˜Ÿåˆ—æº¢å‡ºäº†</p>
<h5 id="åŠè¿æ¥é˜Ÿåˆ—çš„é•¿åº¦"><a href="#åŠè¿æ¥é˜Ÿåˆ—çš„é•¿åº¦" class="headerlink" title="åŠè¿æ¥é˜Ÿåˆ—çš„é•¿åº¦"></a>åŠè¿æ¥é˜Ÿåˆ—çš„é•¿åº¦</h5><ul>
<li>åŠè¿æ¥é˜Ÿåˆ—çš„é•¿åº¦æ˜¯ <em><strong>minï¼ˆbacklogï¼Œsomaxconnï¼Œtcp_max_syn_backlogï¼‰ + 1</strong></em> å†å‘ä¸Šå»æ•´åˆ° <strong>2</strong> çš„ <em><strong>N</strong></em> æ¬¡å¹‚ï¼Œä½†æœ€å°ä¸èƒ½å°äº <strong>16</strong></li>
<li><code>cat /proc/sys/net/ipv4/tcp_max_syn_backlog</code> å‘½ä»¤æŸ¥çœ‹ tcp_max_syn_backlog</li>
<li>å‡è®¾æŸå†…æ ¸å‚æ•° net.core.somaxconn&#x3D;128ï¼Œnet.ipv4.tcp_max_syn_backlog&#x3D;8192ï¼Œç”¨æˆ· backlog&#x3D;5ï¼Œç»è¿‡ä»¥ä¸‹æ­¥éª¤è®¡ç®—å¾—å‡ºä¸º 16<ul>
<li>min(backlog, somaxconn) &#x3D; min(5, 128) &#x3D; 5</li>
<li>min(5, tcp_max_syn_backlog) &#x3D; min(5, 8192) &#x3D; 5</li>
<li>maxï¼ˆ5ï¼Œ 8ï¼‰ &#x3D; 8  è¿™ä¸€æ­¥æ˜¯å†…æ ¸ä¸ºäº†é¿å…ä¼ å…¥ä¸€ä¸ªå¤ªå°çš„å€¼å¯¼è‡´æ— æ³•æ¥æ”¶è¿æ¥ï¼Œæ‰€ä»¥å¿…é¡»è¦&gt;&#x3D;8</li>
<li>roundup_pow_of_two(8 + 1) &#x3D; 16</li>
</ul>
</li>
<li>å‡è®¾æŸå†…æ ¸å‚æ•° net.core.somaxconn&#x3D;128ï¼Œnet.ipv4.tcp_max_syn_backlog&#x3D;8192ï¼Œç”¨æˆ· backlog&#x3D;512ï¼Œç»è¿‡ä»¥ä¸‹æ­¥éª¤è®¡ç®—å¾—å‡ºä¸º 256<ul>
<li>min(backlog, somaxconn) &#x3D; min(512, 128) &#x3D; 128</li>
<li>min(128, tcp_max_syn_backlog) &#x3D; min(128, 8192) &#x3D; 128</li>
<li>max(128, 8) &#x3D; 128  </li>
<li>roundup_pow_of_two(128 + 1) &#x3D; 256</li>
</ul>
</li>
</ul>
<h5 id="åˆ¤æ–­åŠè¿æ¥é˜Ÿåˆ—æ˜¯å¦æº¢å‡ºï¼Ÿ"><a href="#åˆ¤æ–­åŠè¿æ¥é˜Ÿåˆ—æ˜¯å¦æº¢å‡ºï¼Ÿ" class="headerlink" title="åˆ¤æ–­åŠè¿æ¥é˜Ÿåˆ—æ˜¯å¦æº¢å‡ºï¼Ÿ"></a>åˆ¤æ–­åŠè¿æ¥é˜Ÿåˆ—æ˜¯å¦æº¢å‡ºï¼Ÿ</h5><ol>
<li>è®¡ç®—åŠè¿æ¥é˜Ÿåˆ—çš„é•¿åº¦</li>
<li>æŸ¥çœ‹å½“å‰SYN_RECVçŠ¶æ€çš„è¿æ¥æ•°é‡</li>
</ol>
<p><strong><code>netstat -antp | grep SYN_RECV | wc -l</code></strong></p>
<p>å…¶å®åªéœ€è¦ä¿è¯ <strong><code>tcp_syncookies</code></strong> è¿™ä¸ªå†…æ ¸å‚æ•°æ˜¯ <strong>1</strong> å°±ä¸ä¼šæœ‰åŠè¿æ¥é˜Ÿåˆ—æº¢å‡ºçš„é—®é¢˜ï¼ŒğŸ‘ğŸ»æ¨èå¼€å¯æ­¤å‚æ•°ï¼ï¼ä¸”å¼€å¯æ­¤å‚æ•°å¯ä»¥æŠµå¾¡ SYN flood æ”»å‡»</p>
<p><strong><code>cat /proc/sys/net/ipv4/tcp_syncookies</code></strong> é€šè¿‡æ­¤å‘½ä»¤æŸ¥çœ‹å¯¹åº”å‚æ•°</p>
<p><strong><code>echo 1 &gt; /proc/sys/net/ipv4/tcp_syncookies</code></strong> æ­¤å‘½ä»¤è¿›è¡Œä¿®æ”¹</p>
<h3 id="Connect"><a href="#Connect" class="headerlink" title="Connect"></a>Connect</h3><p>å®¢æˆ·ç«¯åœ¨æ‰§è¡Œ connect å‡½æ•°çš„æ—¶å€™ï¼ŒæŠŠæœ¬åœ° socket çŠ¶æ€è®¾ç½®æˆäº†**<code>TCP_SYN_SENT</code>**ï¼Œé€‰äº†ä¸€ä¸ªå¯ç”¨ç«¯å£ï¼Œæ¥ç€å‘å‡º SYN æ¡æ‰‹è¯·æ±‚å¹¶å¯åŠ¨é‡ä¼ å®šæ—¶å™¨</p>
<h4 id="é€‰æ‹©å¯ç”¨ç«¯å£"><a href="#é€‰æ‹©å¯ç”¨ç«¯å£" class="headerlink" title="é€‰æ‹©å¯ç”¨ç«¯å£"></a>é€‰æ‹©å¯ç”¨ç«¯å£</h4><ol>
<li>å¦‚æœè°ƒç”¨è¿‡ bindï¼Œé‚£ä¹ˆä»¥ bind å®šä¹‰çš„ç«¯å£ä¸ºå‡†ï¼Œå¦åˆ™éœ€è¦æŒ‰ç…§ä»¥ä¸‹è§„åˆ™å¯»æ‰¾å¯ç”¨çš„ç«¯å£</li>
<li>å¯ç”¨çš„ç«¯å£èŒƒå›´æ˜¯æ ¹æ®å†…æ ¸å‚æ•° <strong><code>net.ipv4.ip_local_port_range</code></strong>ï¼Œæ­¤å‚æ•°çš„èŒƒå›´å°±æ˜¯èƒ½é€‰æ‹©çš„ç«¯å£èŒƒå›´ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤ **<code>cat /proc/sys/net/ipv4/ip_local_port_range</code>**è¿›è¡ŒæŸ¥çœ‹ï¼Œä¸‹å›¾è¡¨ç¤ºèƒ½ä½¿ç”¨çš„èŒƒå›´æ˜¯ 32768-60999ã€‚æ³¨æ„è¿™é‡ŒæŸ¥æ‰¾ç«¯å£æ˜¯å¾ªç¯çš„ï¼Œå¦‚æœéœ€è¦å¾ˆå¤šè½®æ‰æŸ¥æ‰¾åˆ°å¯ç”¨çš„ç«¯å£ï¼Œä¼šå¯¼è‡´ connect ç³»ç»Ÿè°ƒç”¨çš„ cpu å‡é«˜<ul>
<li><img data-src="/images/tcp_01_04.png" alt="img"></li>
</ul>
</li>
<li>åˆ¤æ–­é€‰æ‹©çš„ç«¯å£æ˜¯å¦åœ¨ä¿ç•™ç«¯å£ä¸­ï¼Œå¦‚æœæ˜¯åˆ™ä¸èƒ½ä½¿ç”¨æ­¤ç«¯å£ã€‚å†…æ ¸å‚æ•°**<code>net.ipv4.ip_local_reserved_ports</code>** è¡¨ç¤ºä¿ç•™ç«¯å£ï¼Œå¦‚æœå¸Œæœ›æŸäº›ç«¯å£ä¸è¢«å†…æ ¸ä½¿ç”¨ï¼Œå°†ä»–ä»¬å†™åˆ°è¿™ä¸ªå‚æ•°é‡Œé¢å°±å¯ä»¥ã€‚<strong><code>cat /proc/sys/net/ipv4/ip_local_reserved_ports</code></strong></li>
<li>åˆ¤æ–­é€‰æ‹©çš„ç«¯å£æ˜¯å¦å·²ç»ä½¿ç”¨è¿‡äº†ï¼Œå†…æ ¸ä¼šç»´æŠ¤ä¸€ä¸ªä½¿ç”¨è¿‡çš„ç«¯å£çš„ hash è¡¨ï¼Œå¦‚æœåœ¨ hash è¡¨ä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œè¯æ˜æ­¤ç«¯å£æ˜¯å¯ç”¨çš„ï¼Œåé¢ä¼šåœ¨æ­¤ hash è¡¨ä¸­è®°å½•ç«¯å£å·²ç»è¢«ä½¿ç”¨</li>
<li>å¦‚æœä¸Šé¢è¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„ç«¯å£ï¼Œå°±ä¼šå‡ºç° <strong>Cannot assign requested address</strong> è¿™ä¸ªé”™è¯¯</li>
</ol>
<h4 id="ç«¯å£è¢«ä½¿ç”¨è¿‡æ€ä¹ˆåŠï¼Ÿ"><a href="#ç«¯å£è¢«ä½¿ç”¨è¿‡æ€ä¹ˆåŠï¼Ÿ" class="headerlink" title="ç«¯å£è¢«ä½¿ç”¨è¿‡æ€ä¹ˆåŠï¼Ÿ"></a>ç«¯å£è¢«ä½¿ç”¨è¿‡æ€ä¹ˆåŠï¼Ÿ</h4><blockquote>
<p>ğŸ‘†ğŸ»é€‰æ‹©å¯ç”¨ç«¯å£çš„ç¬¬å››æ­¥åˆ¤æ–­ç«¯å£æ˜¯å¦å·²ç»ä½¿ç”¨è¿‡äº†ï¼Œä¸æ˜¯ç®€å•çš„åˆ¤æ–­ç«¯å£æ˜¯å¦ä½¿ç”¨è¿‡äº†ï¼Œè€Œæ˜¯å¦‚æœç«¯å£è¢«ä½¿ç”¨è¿‡äº†ï¼Œä¸”<strong>å››å…ƒç»„å®Œå…¨ä¸€è‡´</strong>æ—¶æ‰æ— æ³•ä½¿ç”¨æ­¤ç«¯å£ï¼Œå¦‚æœå››å…ƒç»„æœ‰ä¸€ä¸ªä¸ä¸€è‡´ï¼Œé‚£ä¹ˆè¿™ä¸ªç«¯å£æ˜¯å¯ä»¥ä½¿ç”¨çš„ã€‚</p>
</blockquote>
<h4 id="å‘èµ·-sync-è¯·æ±‚"><a href="#å‘èµ·-sync-è¯·æ±‚" class="headerlink" title="å‘èµ· sync è¯·æ±‚"></a>å‘èµ· sync è¯·æ±‚</h4><ol>
<li>ç”³è¯·ä¸€ä¸ª skbï¼Œå¹¶å°†å…¶è®¾ç½®ä¸º<code>SYN</code>åŒ…</li>
<li>æ·»åŠ åˆ°å‘é€é˜Ÿåˆ— <code>sk_write_queue</code> </li>
<li>è°ƒç”¨<code>tcp_transmit_skb</code>å°†è¯¥åŒ…å‘å‡º</li>
<li>å¯åŠ¨ä¸€ä¸ªé‡ä¼ å®šæ—¶å™¨ï¼Œè¶…æ—¶ä¼šé‡å‘ã€‚é¦–æ¬¡è¶…æ—¶æ—¶é—´æ˜¯åœ¨<code>TCP_TIMEOUT_INIT</code>å®ä¸­å®šä¹‰çš„</li>
</ol>
<h3 id="ä¸‰æ¬¡æ¡æ‰‹"><a href="#ä¸‰æ¬¡æ¡æ‰‹" class="headerlink" title="ä¸‰æ¬¡æ¡æ‰‹"></a>ä¸‰æ¬¡æ¡æ‰‹</h3><p><img data-src="/images/tcp_01_05.png" alt="img"></p>
<ol>
<li>ç¬¬ä¸€æ¬¡æ¡æ‰‹æœåŠ¡ç«¯åªæ˜¯åˆ›å»ºäº†**<code>request sock</code>**ï¼Œå¹¶åŠ å…¥åˆ°åŠè¿æ¥é˜Ÿåˆ—ä¸­ï¼Œå¹¶æ²¡æœ‰åˆ›å»º socketï¼Œå®é™…åˆ›å»ºsocketæ˜¯åœ¨ä¸‰æ¬¡æ¡æ‰‹å®Œæˆæ—¶ã€‚</li>
<li>TCP è¿æ¥å»ºç«‹çš„ç½‘ç»œè€—æ—¶å¤§çº¦éœ€è¦ä¸‰æ¬¡ä¼ è¾“ï¼Œå†åŠ ä¸Šå°‘è®¸çš„åŒæ–¹ cpu å¼€é”€ï¼Œæ€»å…±å¤§çº¦æ¯” <strong>1.5 å€ RTT</strong> å¤§ä¸€ç‚¹ç‚¹ã€‚ä¸è¿‡ä»å®¢æˆ·ç«¯è§’åº¦æ¥çœ‹ï¼Œåªè¦ ACK åŒ…å‘å‡ºäº†ï¼Œå†…æ ¸å°±è®¤ä¸ºè¿æ¥å»ºç«‹æˆåŠŸå¯ä»¥å¼€å§‹å‘é€æ•°æ®äº†ï¼Œæ‰€ä»¥å¦‚æœåœ¨å®¢æˆ·ç«¯è¿›è¡Œæ‰“ç‚¹ç»Ÿè®¡ TCP è¿æ¥å»ºç«‹è€—æ—¶åªéœ€è¦ä¸¤æ¬¡ä¼ è¾“è€—æ—¶â€”â€”å³ä¸€ä¸ª RTT å¤šä¸€ç‚¹çš„æ—¶é—´ï¼ˆæœåŠ¡ç«¯ä¹Ÿæ˜¯åŒç†ï¼Œä» SYN åŒ…æ¥æ”¶åˆ°å¼€å§‹ç®—èµ·ï¼Œåˆ° ACK åŒ…æ¥æ”¶å®Œæ¯•ï¼‰</li>
</ol>
]]></content>
      <categories>
        <category>ç½‘ç»œ</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>ç½‘ç»œ</tag>
        <tag>tcp</tag>
      </tags>
  </entry>
  <entry>
    <title>linuxå†…æ ¸å‘é€ç½‘ç»œåŒ…</title>
    <url>/2025/02/09/linux-nei-he-fa-song-wang-luo-bao/posts/undefined/</url>
    <content><![CDATA[<h3 id="ç½‘ç»œå‘é€è¿‡ç¨‹æ±‡æ€»"><a href="#ç½‘ç»œå‘é€è¿‡ç¨‹æ±‡æ€»" class="headerlink" title="ç½‘ç»œå‘é€è¿‡ç¨‹æ±‡æ€»"></a>ç½‘ç»œå‘é€è¿‡ç¨‹æ±‡æ€»</h3><p><img data-src="/images/socket_02_10.png" alt="img"></p>
<ul>
<li>ä¸Šå›¾ä¸­ç½‘ç»œè®¾å¤‡å­ç³»ç»Ÿåœ¨å‘é€ç½‘ç»œåŒ…çš„æ—¶å€™ï¼Œæ˜¯é€šè¿‡whileå¾ªç¯ä¸æ–­åœ°ä»é˜Ÿåˆ—ä¸­å–å‡ºskbå¹¶è¿›è¡Œå‘é€ã€‚è¿™æ—¶å€™å…¶å®éƒ½æ˜¯å ç”¨çš„ç”¨æˆ·è¿›ç¨‹çš„ç³»ç»Ÿæ€æ—¶é—´(sy)ï¼Œåªæœ‰å½“<code>quota</code> ç”¨å°½æˆ–è€…å…¶ä»–è¿›ç¨‹éœ€è¦cpuæ—¶æ‰è§¦å‘è½¯ä¸­æ–­è¿›è¡Œå‘é€ã€‚</li>
<li>ç½‘ç»œè®¾å¤‡å­ç³»ç»Ÿçš„é˜Ÿåˆ—å’Œç½‘å¡é©±åŠ¨çš„ Ring Buffer å®é™…ä¸Šæ˜¯ä¸¤ä¸ªä¸åŒçš„æ¦‚å¿µ<ul>
<li>ç½‘ç»œè®¾å¤‡å­ç³»ç»Ÿçš„é˜Ÿåˆ—æ˜¯åœ¨å†…æ ¸ç½‘ç»œæ ˆä¸­çš„è½¯ä»¶é˜Ÿåˆ—ï¼Œå½“æ•°æ®åŒ…ï¼ˆskbï¼‰å‡†å¤‡å‘é€æ—¶ï¼Œå®ƒé¦–å…ˆè¢«æ”¾å…¥è¿™ä¸ªè½¯ä»¶é˜Ÿåˆ—ï¼Œè¿™ä¸ªé˜Ÿåˆ—ä¸»è¦ç”¨äºæµé‡æ§åˆ¶ã€QoSï¼ˆæœåŠ¡è´¨é‡ï¼‰ç®¡ç†ç­‰ç›®çš„</li>
<li>ç½‘å¡é©±åŠ¨çš„ Ring Bufferæ˜¯ä¸€ä¸ªç¡¬ä»¶çº§åˆ«çš„é˜Ÿåˆ—ï¼ŒRing Buffer å­˜å‚¨çš„ä¸æ˜¯å®Œæ•´çš„ skbï¼Œè€Œæ˜¯æŒ‡å‘å†…å­˜ä¸­æ•°æ®åŒ…çš„æè¿°ç¬¦ã€‚</li>
<li>Ring Buffer åŒ…å«ä¸¤ä¸ªä¸»è¦çš„æ•°ç»„ï¼Œä¸¤ä¸ªæ•°ç»„ç›¸åŒindexä¸‹å¯¹åº”å­˜å‚¨äº†åŒä¸€ä¸ªskbï¼Œåªä¸è¿‡å†…æ ¸éœ€è¦çš„æ˜¯skbï¼Œç½‘å¡éœ€è¦å…·ä½“çš„ç‰©ç†åœ°å€ï¼Œé€šè¿‡æ­¤è®¾è®¡å½“ç½‘å¡å‘é€å®Œæ¯•åï¼Œå†…æ ¸é€šè¿‡åŒä¸€ä¸ªindexèƒ½å®šä½åˆ°skbä»è€Œè¿›è¡Œæ¸…ç†ç­‰å·¥ä½œã€‚<ol>
<li>æè¿°ç¬¦æ•°ç»„ï¼ˆDescriptor Ringï¼‰ä¸»è¦æ˜¯ç½‘å¡ä½¿ç”¨</li>
<li>ç¼“å†²åŒºä¿¡æ¯æ•°ç»„ï¼ˆBuffer Info Arrayï¼‰ä¸»è¦æ˜¯å†…æ ¸ä½¿ç”¨</li>
</ol>
</li>
</ul>
</li>
<li>åœ¨ç›‘æ§å†…æ ¸å‘é€æ•°æ®æ¶ˆè€—çš„cpuæ—¶ï¼Œåº”è¯¥å°†syã€siéƒ½è€ƒè™‘è¿›æ¥<ul>
<li>ç½‘ç»œåŒ…å‘é€è¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·è¿›ç¨‹(åœ¨å†…æ ¸æ€)å®Œæˆäº†ç»å¤§éƒ¨åˆ†çš„å·¥ä½œï¼Œç”šè‡³è¿è°ƒç”¨é©±åŠ¨çš„å·¥ä½œéƒ½å¹²äº†ã€‚åªæœ‰å½“å†…æ ¸æ€è¿›ç¨‹è¢«åˆ‡èµ°å‰æ‰ä¼šå‘èµ·è½¯ä¸­æ–­ã€‚å‘é€è¿‡ç¨‹ä¸­ï¼Œç»å¤§éƒ¨åˆ†ï¼ˆ90%ï¼‰ä»¥ä¸Šçš„å¼€é”€éƒ½æ˜¯åœ¨ç”¨æˆ·è¿›ç¨‹å†…æ ¸æ€æ¶ˆè€—æ‰çš„ã€‚</li>
<li>åªæœ‰ä¸€å°‘éƒ¨åˆ†æƒ…å†µæ‰ä¼šè§¦å‘è½¯ä¸­æ–­ï¼ˆNET_TXç±»å‹ï¼‰ï¼Œç”±è½¯ä¸­æ–­ksoftirqdçº¿ç¨‹æ¥å‘é€ã€‚</li>
</ul>
</li>
<li>åœ¨æœåŠ¡å™¨ä¸ŠæŸ¥çœ‹&#x2F;proc&#x2F;softirqsï¼Œä¸ºä»€ä¹ˆNET_RXæ¯”NET_TXå¤§çš„å¤šçš„å¤šï¼Ÿ<ul>
<li>å½“æ•°æ®å‘é€å®Œæ¯•åï¼Œé€šè¿‡ç¡¬ä¸­æ–­çš„æ–¹å¼æ¥é€šçŸ¥é©±åŠ¨å‘é€å®Œæˆï¼Œä½†æ˜¯ç¡¬ä¸­æ–­æ— è®ºæ˜¯æ•°æ®æ¥æ”¶ï¼Œè¿˜æ˜¯å‘é€å®Œæ¯•ï¼Œè§¦å‘çš„è½¯ä¸­æ–­éƒ½æ˜¯NET_RX_SOFTIRQã€‚</li>
<li>å¯¹äºè¯»æ¥è¯´ï¼Œéƒ½æ˜¯éœ€è¦ç»è¿‡NET_RXè½¯ä¸­æ–­çš„ï¼Œéƒ½èµ°ksoftirqdå†…æ ¸çº¿ç¨‹ï¼Œè€Œå¯¹äºå‘é€æ¥è¯´ï¼Œç»å¤§éƒ¨åˆ†å·¥ä½œéƒ½æ˜¯åœ¨ç”¨æˆ·è¿›ç¨‹å†…æ ¸æ€å¤„ç†äº†ï¼Œåªæœ‰ç³»ç»Ÿæ€é…é¢ç”¨å°½æ‰å‘å‡ºNET_TXï¼Œè®©è½¯ä¸­æ–­ä¸Šã€‚</li>
</ul>
</li>
</ul>
<h3 id="å‘é€ç½‘ç»œæ•°æ®çš„æ—¶å€™éƒ½æ¶‰åŠå“ªäº›å†…å­˜æ‹·è´"><a href="#å‘é€ç½‘ç»œæ•°æ®çš„æ—¶å€™éƒ½æ¶‰åŠå“ªäº›å†…å­˜æ‹·è´" class="headerlink" title="å‘é€ç½‘ç»œæ•°æ®çš„æ—¶å€™éƒ½æ¶‰åŠå“ªäº›å†…å­˜æ‹·è´?"></a>å‘é€ç½‘ç»œæ•°æ®çš„æ—¶å€™éƒ½æ¶‰åŠå“ªäº›å†…å­˜æ‹·è´?</h3><blockquote>
<p>æŒ‡å¾…å‘é€æ•°æ®çš„å†…å­˜æ‹·è´</p>
</blockquote>
<ol>
<li>ç¬¬ä¸€æ¬¡æ‹·è´æ“ä½œæ˜¯åœ¨å†…æ ¸ç”³è¯·å®Œskbä¹‹åï¼Œè¿™æ—¶å€™ä¼šå°†ç”¨æˆ·ä¼ é€’è¿›æ¥çš„bufferé‡Œçš„æ•°æ®å†…å®¹éƒ½æ‹·è´åˆ°skbã€‚å¦‚æœè¦å‘é€çš„æ•°æ®é‡æ¯”è¾ƒå¤§ï¼Œè¿™ä¸ªæ‹·è´æ“ä½œå¼€é”€ä¸å°ã€‚</li>
<li>ç¬¬äºŒæ¬¡æ‹·è´æ“ä½œæ˜¯ä»ä¼ è¾“å±‚è¿›å…¥ç½‘ç»œå±‚çš„æ—¶å€™ï¼Œæ¯ä¸€ä¸ªskbéƒ½ä¼šè¢«å…‹éš†å‡ºæ¥ä¸€ä¸ªæ–°çš„å‰¯æœ¬ã€‚ç›®çš„æ˜¯ä¿ç•™åŸå§‹çš„skbï¼Œå½“ç½‘ç»œå‘ç°å¯¹æ–¹æ²¡æœ‰è¿”å›ackçš„æ—¶å€™ï¼Œè¿˜å¯ä»¥é‡æ–°å‘é€ï¼Œä»¥å®ç°TCPä¸­è¦æ±‚çš„å¯é ä¼ è¾“ï¼Œä¸è¿‡è¿™æ¬¡åªæ˜¯æµ…æ‹·è´ï¼Œåªæ‹·è´skbæè¿°ç¬¦æœ¬èº«ï¼Œæ‰€æŒ‡å‘çš„æ•°æ®è¿˜æ˜¯å¤ç”¨çš„ã€‚</li>
<li>ç¬¬ä¸‰æ¬¡æ‹·è´ä¸æ˜¯å¿…é¡»çš„ï¼Œåªæœ‰å½“IPå±‚å‘ç°skbå¤§äºMTUæ—¶æ‰éœ€è¦è¿›è¡Œã€‚æ­¤æ—¶ä¼šå†ç”³è¯·é¢å¤–çš„skbï¼Œå¹¶è®²ç©¶åŸæ¥çš„skbæ‹·è´ä¸ºå¤šä¸ªå°çš„skbã€‚</li>
</ol>
]]></content>
      <categories>
        <category>ç½‘ç»œ</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>ç½‘ç»œ</tag>
        <tag>socket</tag>
      </tags>
  </entry>
  <entry>
    <title>linuxå†…æ ¸æ¥æ”¶ç½‘ç»œåŒ…</title>
    <url>/2025/02/09/linux-nei-he-jie-shou-wang-luo-bao/posts/undefined/</url>
    <content><![CDATA[<h3 id="RingBuffer"><a href="#RingBuffer" class="headerlink" title="RingBuffer"></a>RingBuffer</h3><h4 id="RingBufferåˆ°åº•æ˜¯ä»€ä¹ˆ"><a href="#RingBufferåˆ°åº•æ˜¯ä»€ä¹ˆ" class="headerlink" title="RingBufferåˆ°åº•æ˜¯ä»€ä¹ˆ?"></a>RingBufferåˆ°åº•æ˜¯ä»€ä¹ˆ?</h4><blockquote>
<p>æ˜¯å†…å­˜ä¸­çš„ä¸€å—ç‰¹æ®ŠåŒºåŸŸï¼Œç¯å½¢é˜Ÿåˆ—æ˜¯ç¬¼ç»Ÿçš„è¯´æ³•ï¼Œå®é™…ä¸ŠåŒ…æ‹¬<code>igb_rx_buffer</code> ç¯å½¢é˜Ÿåˆ—æ•°ç»„ã€<code>e1000_adv_rx_desc</code> ç¯å½¢é˜Ÿåˆ—æ•°ç»„åŠä¼—å¤šçš„skb</p>
</blockquote>
<p><img data-src="/images/socket_02_01.png" alt="img"></p>
<p>ç½‘å¡åœ¨æ”¶åˆ°æ•°æ®çš„æ—¶å€™ä»¥<code>DMA</code> æ–¹å¼å°†åŒ…å†™åˆ°RingBufferä¸­ã€‚è½¯ä¸­æ–­æ”¶åŒ…çš„æ—¶å€™æ¥è¿™é‡Œå°†skbå–èµ°ï¼Œå¹¶ç”³è¯·æ–°çš„skbé‡æ–°æŒ‚ä¸Šå»ã€‚</p>
<p>RingBufferå†…å­˜æ˜¯é¢„å…ˆåˆ†é…çš„è¿˜æ˜¯åŠ¨æ€åˆ†é…çš„ï¼Ÿ</p>
<p>æŒ‡é’ˆæ•°ç»„æ˜¯é¢„å…ˆåˆ†é…å¥½çš„ï¼Œè€Œskbè™½ç„¶ä¹Ÿä¼šé¢„å…ˆåˆ†é…å¥½ï¼Œä½†æ˜¯åœ¨åé¢çš„æ”¶åŒ…è¿‡ç¨‹ä¸­ä¼šä¸æ–­çš„åŠ¨æ€åœ°åˆ†é…ç”³è¯·</p>
<h4 id="RingBufferä¸ºä»€ä¹ˆä¼šä¸¢åŒ…ï¼Ÿ"><a href="#RingBufferä¸ºä»€ä¹ˆä¼šä¸¢åŒ…ï¼Ÿ" class="headerlink" title="RingBufferä¸ºä»€ä¹ˆä¼šä¸¢åŒ…ï¼Ÿ"></a>RingBufferä¸ºä»€ä¹ˆä¼šä¸¢åŒ…ï¼Ÿ</h4><ul>
<li>RingBufferæ˜¯æœ‰å¤§å°å’Œé•¿åº¦é™åˆ¶çš„</li>
<li>ä½¿ç”¨ <code>ethtool -g eth0</code> å‘½ä»¤æŸ¥çœ‹é•¿åº¦ï¼ŒPre-set maximums æŒ‡çš„æ˜¯æœ€å¤§å€¼ï¼ŒCurrent hardware settings è¡¨ç¤ºå½“å‰è®¾ç½®ï¼Œä¸‹å›¾è¡¨ç¤ºæœ€å¤§å…è®¸1024ï¼Œç›®å‰è®¾ç½®ä¸º1024</li>
</ul>
<p><img data-src="/images/socket_02_02.png" alt="img"></p>
<ul>
<li>æŸ¥çœ‹æ˜¯å¦æœ‰æº¢å‡ºæƒ…å†µå‘ç”Ÿ  <code>ethtool -S eth0</code>ï¼Œå¦‚æœæœ‰æº¢å‡ºæƒ…å†µå‘ç”Ÿ(ifconfigä¸­ä½“ç°ä¸ºoverrunsæŒ‡æ ‡å¢é•¿)ï¼Œè¡¨ç¤ºæœ‰åŒ…å› ä¸ºRingBufferè£…ä¸ä¸‹è€Œè¢«ä¸¢å¼ƒäº†ï¼Œè§£å†³æ€è·¯æœ‰ä¸¤ç§<ul>
<li>åŠ å¤§RingBufferé•¿åº¦ <code>ethtool -G eth0 rx 4096 tx 4096</code> ï¼Œæ­¤ç§æ–¹å¼åªæ˜¯ä¸´æ—¶è§£å†³ï¼Œæ²»æ ‡ä¸æ²»æœ¬</li>
<li>å¼€å¯å¤šé˜Ÿåˆ—æå‡ç½‘ç»œæ€§èƒ½ï¼Œæ‰“æ•£é˜Ÿåˆ—çš„äº²æ ¸æ€§</li>
<li>ç°åœ¨ä¸»æµç½‘å¡åŸºæœ¬ä¸Šéƒ½æ”¯æŒå¤šé˜Ÿåˆ—ï¼Œé€šè¿‡<code>ethtool -l eth0</code> è¿›è¡ŒæŸ¥çœ‹ï¼Œä¸‹å›¾è¡¨ç¤ºå½“å‰ç½‘å¡æ”¯æŒçš„æœ€å¤§é˜Ÿåˆ—æ•°æ˜¯2ï¼Œå½“å‰å¼€å¯çš„ä¹Ÿæ˜¯2ï¼Œé€šè¿‡sysfsä¹Ÿå¯ä»¥çœ‹åˆ°çœŸæ­£ç”Ÿæ•ˆçš„é˜Ÿåˆ—æ•°é‡ã€‚</li>
<li><img data-src="/images/socket_02_03.png" alt="img"></li>
<li><img data-src="/images/socket_02_04.png" alt="img"></li>
<li>åŠ å¤§é˜Ÿåˆ—æ•°é‡ï¼Œå¯ä»¥ä½¿ç”¨ <code>ethtool -L eth0 combined 32</code> </li>
<li>å¦‚æœå‘ç°æŸä¸ªcpuæ ¸å¿ƒsiç‰¹åˆ«é«˜ï¼Œå¯ä»¥è€ƒè™‘è°ƒæ•´é˜Ÿåˆ—äº²å’Œçš„cpuæ ¸å¿ƒ<ul>
<li><code>cat /proc/interrupts</code>æŸ¥çœ‹é˜Ÿåˆ—çš„ç¡¬ä»¶ç¡¬ä¸­æ–­ï¼Œä¸‹å›¾æ˜¾ç¤ºè¾“å…¥é˜Ÿåˆ—0çš„ä¸­æ–­å·æ˜¯25ï¼Œé˜Ÿåˆ—1çš„ä¸­æ–­å·æ˜¯27ï¼Œé€šè¿‡è¿™ä¸ªä¸­æ–­å·å¯¹åº”çš„<code>smp_affinity</code>å¯ä»¥æŸ¥çœ‹åˆ°äº²å’Œçš„cpuæ ¸æ˜¯å“ªä¸ªã€‚ä¸‹å›¾æ˜¾ç¤ºçš„2åœ¨äºŒè¿›åˆ¶ä¸­ä»£è¡¨ç¬¬äºŒä½æ˜¯1ï¼Œæ‰€ä»¥è¡¨ç¤ºç¬¬2ä¸ªcpuæ ¸å¿ƒâ€”â€”CPU2</li>
<li><img data-src="/images/socket_02_05.png" alt="img"></li>
<li><img data-src="/images/socket_02_06.png" alt="img"></li>
<li>æ¯ä¸ªé˜Ÿåˆ—éƒ½ä¼šæœ‰ç‹¬ç«‹çš„ã€ä¸åŒçš„ä¸­æ–­å·ã€‚æ‰€ä»¥ä¸åŒçš„é˜Ÿåˆ—åœ¨å°†æ•°æ®æ”¶å–åˆ°è‡ªå·±çš„RingBufferåï¼Œå¯ä»¥åˆ†åˆ«å‘ä¸åŒçš„CPUå‘èµ·ç¡¬ä¸­æ–­é€šçŸ¥ã€‚è€Œåœ¨ç¡¬ä¸­æ–­çš„å¤„ç†ä¸­ï¼Œå‘èµ·è½¯ä¸­æ–­æ˜¯åŸºäºå½“å‰æ ¸å¿ƒçš„ï¼Œè¿™æ„å‘³ç€<strong>å“ªä¸ªæ ¸å“åº”çš„ç¡¬ä¸­æ–­ï¼Œé‚£ä¹ˆè¯¥ç¡¬ä¸­æ–­å‘èµ·çš„è½¯ä¸­æ–­ä»»åŠ¡å°±å¿…ç„¶ç”±è¿™ä¸ªæ ¸æ¥å¤„ç†</strong>ã€‚</li>
<li>é€šè¿‡è®¾ç½®æ¯ä¸ªé˜Ÿåˆ—ä¸­æ–­å·ä¸Šçš„<code>smp_affinity</code>ï¼Œå°†å„ä¸ªé˜Ÿåˆ—çš„ç¡¬ä¸­æ–­æ‰“æ•£åˆ°ä¸åŒçš„cpuä¸Šã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="ç½‘ç»œç›¸å…³çš„ç¡¬ä¸­æ–­ã€è½¯ä¸­æ–­éƒ½æ˜¯ä»€ä¹ˆ"><a href="#ç½‘ç»œç›¸å…³çš„ç¡¬ä¸­æ–­ã€è½¯ä¸­æ–­éƒ½æ˜¯ä»€ä¹ˆ" class="headerlink" title="ç½‘ç»œç›¸å…³çš„ç¡¬ä¸­æ–­ã€è½¯ä¸­æ–­éƒ½æ˜¯ä»€ä¹ˆ?"></a>ç½‘ç»œç›¸å…³çš„ç¡¬ä¸­æ–­ã€è½¯ä¸­æ–­éƒ½æ˜¯ä»€ä¹ˆ?</h3><p> åœ¨ç½‘å¡å°†æ•°æ®æ”¾åˆ°<code>RingBuffer</code> ä¹‹åï¼Œæ¥ç€å°±å‘èµ·<code>ç¡¬ä¸­æ–­</code>ï¼Œé€šçŸ¥cpuè¿›è¡Œå¤„ç†ã€‚ä¸è¿‡åœ¨ç¡¬ä¸­æ–­çš„ä¸Šä¸‹æ–‡é‡Œåšçš„å·¥ä½œå¾ˆå°‘ï¼Œå°†ä¼ è¿‡æ¥çš„<code>poll_list</code> æ·»åŠ åˆ°æ¯ä¸ªcpuå˜é‡<code>softnet_data</code> çš„ <code>poll_list</code> é‡Œé¢ï¼Œæ¥ç€è§¦å‘<code>è½¯ä¸­æ–­</code> <code>NET_RX_SOFTIRQ</code>ã€‚åœ¨è½¯ä¸­æ–­ä¸­å¯¹softnet_dataçš„è®¾å¤‡åˆ—è¡¨poll_listè¿›è¡Œéå†ï¼Œæ‰§è¡Œç½‘å¡é©±åŠ¨æä¾›çš„pollæ¥æ”¶å–ç½‘ç»œåŒ…ã€‚å¤„ç†å®Œæˆåä¼šé€åˆ°åè®®æ ˆçš„ip_rcvã€udp_rcvã€tcp_rcv_v4ç­‰å‡½æ•°ä¸­</p>
<p>poll_list æ˜¯ä¸ªåŒå‘é“¾è¡¨ï¼Œå­˜å‚¨å¾…å¤„ç†NAPIå®ä¾‹çš„é“¾è¡¨ã€‚</p>
<p>ä¸€ä¸ªç½‘å¡é©±åŠ¨ç¨‹åºé€šå¸¸ä¼šæ³¨å†Œä¸€ä¸ªNAPIç»“æ„(struct napi_struct)ï¼Œè¿™ä¸ªç»“æ„åŸºæœ¬çº¦ç­‰äºä¸€ä¸ªæ¥æ”¶é˜Ÿåˆ—ï¼Œç›®çš„æ˜¯ä¸ºäº†å‡å°‘ç¡¬ä¸­æ–­çš„æ¬¡æ•°ã€‚åœ¨é«˜å¹¶å‘ç½‘ç»œä¸­ï¼Œé¢‘ç¹çš„æ¥æ”¶åˆ°ç½‘ç»œåŒ…å¯¼è‡´é¢‘ç¹è§¦å‘ç¡¬ä¸­æ–­ï¼Œæµªè´¹äº†CPUæ€§èƒ½ï¼Œé€šè¿‡NAPIä¸€ä¸ªé˜Ÿåˆ—ä¸­æ¥æ”¶åˆ°ç½‘ç»œåŒ…åå°†æ­¤é˜Ÿåˆ—ä¿¡æ¯ä¼ é€’ç»™è½¯ä¸­æ–­ï¼Œè½¯ä¸­æ–­å¤„ç†ç¨‹åºåœ¨å¤„ç†çš„æ—¶å€™å…ˆåœæ­¢è§¦å‘ç¡¬ä¸­æ–­ï¼Œä¸“æ³¨æ¥æ”¶åŒ…çš„å¤„ç†ï¼Œå¤„ç†å®Œæˆåå†æ‰“å¼€ç¡¬ä¸­æ–­è§¦å‘ï¼Œå¤§å¤§å‡å°‘äº†ç¡¬ä¸­æ–­çš„è§¦å‘ã€‚</p>
<h3 id="ksoftirqdå†…æ ¸çº¿ç¨‹æ˜¯ç”¨æ¥å¹²å˜›çš„"><a href="#ksoftirqdå†…æ ¸çº¿ç¨‹æ˜¯ç”¨æ¥å¹²å˜›çš„" class="headerlink" title="ksoftirqdå†…æ ¸çº¿ç¨‹æ˜¯ç”¨æ¥å¹²å˜›çš„?"></a>ksoftirqdå†…æ ¸çº¿ç¨‹æ˜¯ç”¨æ¥å¹²å˜›çš„?</h3><ul>
<li>æœºå™¨ä¸Šæœ‰å‡ æ ¸ï¼Œå†…æ ¸å°±ä¼šåˆ›å»ºå‡ ä¸ªksoftirqdçº¿ç¨‹å‡ºæ¥</li>
<li>å†…æ ¸çº¿ç¨‹ksoftirqdåŒ…å«äº†æ‰€æœ‰çš„è½¯ä¸­æ–­å¤„ç†é€»è¾‘ï¼Œè½¯ä¸­æ–­ä¿¡æ¯å¯ä»¥é€šè¿‡ <code>cat /proc/softirqs</code> å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹</li>
</ul>
<p><img data-src="/images/socket_02_07.png" alt="img"></p>
<h3 id="tcpdumpæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ"><a href="#tcpdumpæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ" class="headerlink" title="tcpdumpæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ"></a>tcpdumpæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ</h3><blockquote>
<p>tcpdumpå·¥ä½œåœ¨è®¾å¤‡å±‚ï¼Œæ˜¯é€šè¿‡è™šæ‹Ÿåè®®çš„æ–¹å¼å·¥ä½œçš„ã€‚é€šè¿‡è°ƒç”¨packet_createå°†æŠ“åŒ…å‡½æ•°ä»¥åè®®çš„å½¢å¼æŒ‚åˆ°ptype_allä¸Šã€‚è¿™ä¸ªå‡½æ•°ä¼šå°†åŒ…é€åˆ°åè®®æ ˆå‡½æ•°(ip_rcvã€arp_rcv)ä¹‹å‰ï¼Œå°†åŒ…å…ˆé€åˆ°ptype_allæŠ“åŒ…ç‚¹ã€‚</p>
</blockquote>
<ul>
<li>iptable&#x2F;netfilter ä¸»è¦æ˜¯åœ¨IPã€ARPç­‰å±‚å®ç°çš„ã€‚å¦‚æœé…ç½®è¿‡äºå¤æ‚çš„è§„åˆ™ï¼Œåˆ™ä¼šæ¶ˆè€—è¿‡å¤šçš„cpuï¼ŒåŠ å¤§ç½‘ç»œå»¶è¿Ÿ</li>
<li>tcpdumpå·¥ä½œåœ¨è®¾å¤‡å±‚ï¼Œå°†åŒ…é€åˆ°ipå±‚ä»¥å‰å°±èƒ½å¤„ç†ï¼Œè€Œnetfilterå·¥ä½œåœ¨IPã€ARPç­‰å±‚ï¼Œä»ä¸‹å›¾æ¥çœ‹ï¼Œnetfilterå·¥ä½œåœ¨tcpdumpä¹‹åï¼Œæ‰€ä»¥iptableå°ç¦è§„åˆ™ä¸å½±å“tcpdumpæŠ“åŒ…ï¼›ä½†æ˜¯å‘åŒ…è¿‡ç¨‹æ°æ°ç›¸åï¼Œå‘åŒ…çš„æ—¶å€™netfilterå…ˆè¿›è¡Œå·¥ä½œï¼Œåœ¨åè®®å±‚å°±è¢«è¿‡æ»¤æ‰äº†ï¼Œæ‰€ä»¥tcpdumpä»€ä¹ˆéƒ½çœ‹ä¸åˆ°ã€‚</li>
</ul>
<p><img data-src="/images/socket_02_08.png" alt="img"></p>
<h3 id="ç½‘ç»œæ¥æ”¶è¿‡ç¨‹ä¸­çš„CPUå¼€é”€å¦‚ä½•æŸ¥çœ‹ï¼Ÿ"><a href="#ç½‘ç»œæ¥æ”¶è¿‡ç¨‹ä¸­çš„CPUå¼€é”€å¦‚ä½•æŸ¥çœ‹ï¼Ÿ" class="headerlink" title="ç½‘ç»œæ¥æ”¶è¿‡ç¨‹ä¸­çš„CPUå¼€é”€å¦‚ä½•æŸ¥çœ‹ï¼Ÿ"></a>ç½‘ç»œæ¥æ”¶è¿‡ç¨‹ä¸­çš„CPUå¼€é”€å¦‚ä½•æŸ¥çœ‹ï¼Ÿ</h3><blockquote>
<p>åœ¨ç½‘ç»œåŒ…çš„æ¥æ”¶è¿‡ç¨‹ä¸­ï¼Œä¸»è¦å·¥ä½œé›†ä¸­åœ¨ç¡¬ä¸­æ–­å’Œè½¯ä¸­æ–­ä¸Šï¼ŒäºŒè€…çš„æ¶ˆè€—å¯ä»¥é€šè¿‡topå‘½ä»¤è¿›è¡ŒæŸ¥çœ‹</p>
</blockquote>
<ul>
<li>è¾“å…¥topå‘½ä»¤åï¼Œå†è¾“å…¥1å³å¯æŸ¥çœ‹ã€‚å…¶ä¸­hiæ˜¯CPUå¤„ç†ç¡¬ä¸­æ–­çš„å¼€é”€ï¼Œsiæ˜¯å¤„ç†è½¯ä¸­æ–­çš„å¼€é”€ï¼Œéƒ½æ˜¯ä»¥ç™¾åˆ†æ¯”çš„å½¢å¼å±•ç°çš„ã€‚</li>
</ul>
<p><img data-src="/images/socket_02_09.png" alt="img"></p>
]]></content>
      <categories>
        <category>ç½‘ç»œ</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>ç½‘ç»œ</tag>
        <tag>socket</tag>
      </tags>
  </entry>
  <entry>
    <title>å¤šçº¿ç¨‹å¼‚å¸¸å¤„ç†</title>
    <url>/2025/02/09/duo-xian-cheng-yi-chang-chu-li/posts/undefined/</url>
    <content><![CDATA[<blockquote>
<p> å¤šçº¿ç¨‹åœºæ™¯ä¸‹ï¼Œå¦‚æœæ²¡æœ‰æ˜¾ç¤ºçš„æ•è·å¼‚å¸¸å¹¶å¤„ç†ï¼Œé‚£ä¹ˆå¼‚å¸¸ä¼šè¾“å‡ºåˆ° System.err ä¸­ï¼Œå¯¼è‡´å¼‚å¸¸ä¿¡æ¯ä¸¢å¤±</p>
</blockquote>
<h3 id="å¼‚å¸¸è¢«åå™¬çš„ä¾‹å­"><a href="#å¼‚å¸¸è¢«åå™¬çš„ä¾‹å­" class="headerlink" title="å¼‚å¸¸è¢«åå™¬çš„ä¾‹å­"></a>å¼‚å¸¸è¢«åå™¬çš„ä¾‹å­</h3><ul>
<li>æ–°èµ·çº¿ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸</li>
</ul>
<blockquote>
<p>ç”±äºæ˜¯æ–°å¯åŠ¨çš„çº¿ç¨‹ï¼Œæ­¤å¼‚å¸¸å¹¶ä¸ä¼šæŠ›åˆ°çˆ¶çº¿ç¨‹æˆ–è€…è°ƒç”¨æ–¹ä¸Šï¼Œå¯¼è‡´å¼‚å¸¸è¢«æ²¡äº†- - </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;è¿™æ˜¯ä¸€ä¸ªå¼‚å¸¸!&quot;</span>);</span><br><span class="line">&#125;).start();</span><br></pre></td></tr></table></figure>

<ul>
<li>çº¿ç¨‹æ± ä¸­æŠ›å‡ºçš„å¼‚å¸¸</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Executors.newFixedThreadPool(<span class="number">1</span>)</span><br><span class="line">        .execute(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;çº¿ç¨‹æ± ä¸­çš„å¼‚å¸¸!&quot;</span>);</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><blockquote>
<p>é’ˆå¯¹ä¸Šé¢å‡ºç°çš„å¼‚å¸¸åå™¬çš„ä¾‹å­ï¼Œæœ‰ä»¥ä¸‹è§£å†³æ–¹æ¡ˆ</p>
</blockquote>
<ul>
<li><p>Try catch æ˜¾ç¤ºå¤„ç†å¼‚å¸¸</p>
</li>
<li><p>æŒ‡å®š<code> Thread.UncaughtExceptionHandler</code></p>
<ul>
<li><p>çº¿ç¨‹å¤„ç†</p>
</li>
<li><p>thread.setUncaughtExceptionHandler</p>
</li>
<li><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Thread.<span class="type">UncaughtExceptionHandler</span> <span class="variable">uncaughtExceptionHandler</span> <span class="operator">=</span> (t, e) -&gt; log.error(<span class="string">&quot;[catch error]thread -&gt; &#123;&#125;, e -&gt; &#123;&#125;&quot;</span>, t, e);</span><br><span class="line"><span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;[catch]è¿™æ˜¯ä¸€ä¸ªå¼‚å¸¸!&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">thread.setUncaughtExceptionHandler(uncaughtExceptionHandler);</span><br><span class="line">thread.start();</span><br></pre></td></tr></table></figure>

</li>
<li><p>çº¿ç¨‹æ± å¤„ç†</p>
</li>
<li><p>new ThreadFactoryBuilder().setUncaughtExceptionHandler  çº¿ç¨‹å·¥å‚ä¸­è®¾ç½®</p>
</li>
<li><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Thread.<span class="type">UncaughtExceptionHandler</span> <span class="variable">uncaughtExceptionHandler</span> <span class="operator">=</span> (t, e) -&gt; log.error(<span class="string">&quot;[catch error]thread -&gt; &#123;&#125;, e -&gt; &#123;&#125;&quot;</span>, t, e);</span><br><span class="line"><span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;[catch]è¿™æ˜¯ä¸€ä¸ªå¼‚å¸¸!&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="type">ThreadPoolExecutor</span> <span class="variable">threadPoolExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, TimeUnit.SECONDS</span><br><span class="line">        , <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">1000</span>)</span><br><span class="line">        , <span class="keyword">new</span> <span class="title class_">ThreadFactoryBuilder</span>().setUncaughtExceptionHandler(uncaughtExceptionHandler).build());</span><br><span class="line">threadPoolExecutor.execute(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;[catch]çº¿ç¨‹æ± ä¸­çš„å¼‚å¸¸!&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p>Hold onâ€¦..æœ‰äººçš„åœ°æ–¹å°±ä¸å­˜åœ¨ä¿¡ä»»è¿™ä¸€è¯´- -</p>
<h3 id="å…œåº•æ–¹æ¡ˆ"><a href="#å…œåº•æ–¹æ¡ˆ" class="headerlink" title="å…œåº•æ–¹æ¡ˆ"></a>å…œåº•æ–¹æ¡ˆ</h3><blockquote>
<p>ä¸Šé¢çš„è§£å†³æ–¹æ¡ˆæ˜¯æ²¡é—®é¢˜çš„ï¼Œä½†æ˜¯ä½†æ˜¯ä½†æ˜¯ï¼ŒæŸäº›å¼€å‘è€…å¯èƒ½æ²¡æœ‰è¿™ä¸ªæ„è¯†æˆ–è€…å¿˜è®°äº†ï¼Œå¯¼è‡´å¼‚å¸¸è¿˜æ˜¯è¢«åå™¬äº†</p>
</blockquote>
<p>æ—¢ç„¶æœªæ•è·çš„å¼‚å¸¸æœ€ç»ˆä¼šè¾“å‡ºåˆ° <code>System.err</code> é‚£ä¹ˆé‡æ–°è®¾ç½®ç³»ç»Ÿçš„ err å¤„ç†ï¼ŒæŠŠä¿¡æ¯è¾“å‡ºåˆ°æ—¥å¿—ç³»ç»Ÿä¸­ã€‚ä¸‹é¢è¿™ä¸ªæ˜¯å…œåº•æ–¹æ¡ˆï¼Œä¼šå­˜åœ¨éƒ¨åˆ†çš„ä¸åˆç†ï¼Œä½†æ˜¯ä¸ºäº†ä¸ä¸¢å¼‚å¸¸ä¿¡æ¯è¿˜æ˜¯å¯ä»¥å®¹å¿çš„ï¼Œæ—¥å¸¸å¼€å‘ä¸­å‘ç°æ­¤ç±»å¼‚å¸¸ï¼Œéœ€è¦å®šä½åˆ°å¯¹åº”çš„ä¸šåŠ¡ä»£ç ï¼Œç”¨ä¸Šé¢æä¾›çš„è§£å†³æ–¹æ¡ˆå®Œå–„ä»£ç ï¼›æ¯•ç«Ÿè¿™åªæ˜¯ä¸€ä¸ªå…œåº•çš„æ–¹æ¡ˆï¼Œè€Œä¸æ˜¯å¸¸è§„æ–¹æ¡ˆ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Stderr</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logErr</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="string">&quot;[UnCatchError]&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">PrintStream</span> <span class="variable">STDERR</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintStream</span>(System.err) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">println</span><span class="params">(String x)</span> &#123;</span><br><span class="line">            logErr.error(x);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">println</span><span class="params">(Object x)</span> &#123;</span><br><span class="line">            logErr.error(<span class="string">&quot;&quot;</span> + x);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">(<span class="type">boolean</span> b)</span> &#123;</span><br><span class="line">            logErr.error(<span class="string">&quot;&quot;</span> + b);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">(<span class="type">char</span> c)</span> &#123;</span><br><span class="line">            logErr.error(<span class="string">&quot;&quot;</span> + c);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">            logErr.error(<span class="string">&quot;&quot;</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">(<span class="type">long</span> l)</span> &#123;</span><br><span class="line">            logErr.error(<span class="string">&quot;&quot;</span> + l);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">(<span class="type">float</span> f)</span> &#123;</span><br><span class="line">            logErr.error(<span class="string">&quot;&quot;</span> + f);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">(<span class="type">double</span> d)</span> &#123;</span><br><span class="line">            logErr.error(<span class="string">&quot;&quot;</span> + d);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">(String s)</span> &#123;</span><br><span class="line">            logErr.error(s);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.setErr(STDERR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>JAVA</category>
      </categories>
      <tags>
        <tag>JAVA</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>æŠ“åŒ…ç›¸å…³</title>
    <url>/2025/02/09/zhua-bao-xiang-guan/posts/undefined/</url>
    <content><![CDATA[<ul>
<li>æŸ¥çœ‹è·¯ç”±è¡¨ä¿¡æ¯<ul>
<li>å¯ä»¥æ˜¾ç¤ºæ•°æ®åŒ…çš„è·¯ç”±è§„åˆ™ï¼Œå‘Šè¯‰æˆ‘ä»¬å»å¾€ä¸åŒç›®æ ‡IPæ—¶ä¼šä½¿ç”¨å“ªä¸ªç½‘å¡ï¼Œæ–¹ä¾¿æŒ‡å®šç½‘å¡æŠ“åŒ…</li>
<li><code>netstat -nr</code> æ‰€æœ‰ç³»ç»Ÿå‡å¯ä½¿ç”¨ï¼Œnè¡¨ç¤ºä»¥æ•°å­—å½¢å¼æ˜¾ç¤ºåœ°å€å’Œç«¯å£ï¼Œrè¡¨ç¤ºroute</li>
<li><code>ip route</code> linuxä¸‹ä½¿ç”¨ï¼Œæ›¿ä»£ netstat -r</li>
<li><code>ss</code>linuxä¸‹ä½¿ç”¨ï¼Œæ›¿ä»£ netstat</li>
</ul>
</li>
<li>ç¡®è®¤å·(ack)è®¡ç®—è§„åˆ™<ul>
<li>æ™®é€šæ•°æ®åŒ…ï¼šack &#x3D; å¯¹æ–¹seq + len</li>
<li>SYN&#x2F;FINåŒ…ï¼šack &#x3D; å¯¹æ–¹seq + len + 1</li>
<li>â€œæˆ‘å·²ç»æ”¶åˆ°åˆ°è¿™ä¸ªä½ç½®çš„æ•°æ®äº†â€  â€œä½ ä¸‹æ¬¡å°±ä»è¿™ä¸ªä½ç½®ç»§ç»­å‘â€</li>
</ul>
</li>
<li>seq <ul>
<li>ä¸æ˜¯åŒ…çš„å”¯ä¸€æ ‡è¯†ï¼Œè€Œæ˜¯æ•°æ®æµçš„ä½ç½®æ ‡è®°</li>
<li>è¡¨ç¤ºâ€æˆ‘ä¹‹åçš„æ•°æ®ä¼šä»è¿™ä¸ªä½ç½®å¼€å§‹å‘â€</li>
<li>ä¸‹ä¸€ä¸ªåŒ…çš„seqç­‰äºå¯¹ç«¯ç¡®è®¤çš„ackï¼Œseqã€ackæœ¬è´¨ä¸Šéƒ½æ˜¯æµçš„åºå·ï¼Œackè¡¨ç¤ºå¯¹ç«¯ç¡®è®¤åˆ°äº†è¿™ä¸ªä½ç½®ï¼Œè‡ªç„¶æˆ‘ç«¯éœ€è¦ä»æ­¤ä¸ºæ­¢å‘é€æ•°æ®</li>
</ul>
</li>
<li>æŸäº›åœºæ™¯ä¸‹æŒ¥æ‰‹æ—¶ FIN+ACKå¯èƒ½åˆå¹¶ä¸ºä¸€ä¸ªåŒ…<ul>
<li>å»¶è¿Ÿç¡®è®¤çš„åœºæ™¯ä¸‹ï¼ŒFIN+ACKå¯èƒ½åˆå¹¶ä¸ºä¸€ä¸ªåŒ…</li>
</ul>
</li>
<li>LSO<ul>
<li>ä¼ è¾“å±‚ä¸è´Ÿè´£æ‹†åŒ…å¤„ç†ï¼Œè€Œæ˜¯å°†æ•°æ®ç›´æ¥ä¼ é€’ç»™ç½‘å¡ï¼Œäº¤ç»™ç½‘å¡è´Ÿè´£åˆ†æ®µ</li>
<li>ä¼ ç»Ÿç½‘ç»œæ˜¯åº”ç”¨å±‚æŠŠæ•°æ®äº¤ç»™TCPå±‚ï¼ŒTCPå±‚æ ¹æ®MSSå¤§å°è¿›è¡Œåˆ†æ®µï¼ˆcpuè´Ÿè´£ï¼‰</li>
<li>å¯ç”¨LSOä¹‹åï¼ŒTCPå±‚ç›´æ¥æŠŠæ•°æ®å—ä¼ ç»™ç½‘å¡ï¼Œ è®©ç½‘å¡è´Ÿè´£åˆ†æ®µå·¥ä½œ</li>
<li>ä¼˜ç‚¹åœ¨äºèŠ‚çœäº†cpuèµ„æºï¼Œç¼ºç‚¹åœ¨æ•°æ®å‘é€æ–¹æŠ“åŒ…çš„æ—¶å€™å¯èƒ½çœ‹åˆ°ä¸€ä¸ªåˆ†æ®µå‰ï¼Œè¶…è¿‡MSSçš„å¤§åŒ…</li>
</ul>
</li>
<li>æ•°æ®åŒ…åˆ†æ®µ<ul>
<li>ä¼ è¾“å±‚åˆ†æ®µ(TCPåˆ†æ®µ)<ul>
<li>tcpä¼šæ ¹æ®mssè¿›è¡Œåˆ†æ®µï¼Œä¸€èˆ¬mssçš„é•¿åº¦æ˜¯MTU-40ï¼ŒåŒæ—¶ä¼šå°†IPå±‚çš„flagsæ‰“ä¸ŠDFæ ‡è®°é¿å…ipåˆ†ç‰‡</li>
<li>tcpå±‚åˆ†æ®µçš„å¥½å¤„æ˜¯æ”¯æŒè¶…æ—¶é‡ä¼ å’Œå¿«é€Ÿé‡ä¼ ç­‰æœºåˆ¶ä¿è¯å¯é æ€§</li>
<li>æœ‰æ—¶å€™TCPå¤´ä¸æ­¢20å­—èŠ‚ï¼Œæ‰€ä»¥ä¼šä¾µå ä¸€äº›MSSçš„ç©ºé—´ï¼Œæ¯”å¦‚ç”¨ä½œ TCP Optionsï¼Œè¿™æ ·ä¼ è¾“å±‚çœŸæ­£ç”¨æ¥æ‰¿è½½çš„å­—èŠ‚æ•° &#x3D; MTU(1500) - 20(ip header) - 20(tcp header) - length(Tcp Options)</li>
<li>TCPè¿æ¥å¿…é¡»è¿›è¡Œä¸‰æ¬¡æ¡æ‰‹ï¼Œåœ¨å‰ä¸¤ä¸ªæ¡æ‰‹åŒ…ä¸­åŒæ–¹äº’ç›¸å£°æ˜è‡ªå·±çš„MSSï¼ŒåŒæ–¹é€‚é…å¾—åˆ°å…±è¯†çš„MTUï¼Œè¿™æ ·å°±ä¸ä¼šå‡ºç°å®¢æˆ·ç«¯å‘é€çš„MTUå¤§äºæ¥æ”¶æ–¹çš„æƒ…å†µ</li>
</ul>
</li>
<li>ç½‘ç»œå±‚åˆ†æ®µ(UDP)<ul>
<li>ipå±‚åˆ†ç‰‡ï¼Œä¸¢å¤±ä¸€ä¸ªåˆ†ç‰‡åŒ…å°±éœ€è¦æ•´ä¸ªåŒ…é‡ä¼ </li>
<li>ä½¿ç”¨udpåè®®è‹¥ä¸åœ¨åº”ç”¨å±‚åšå¥½åˆ†æ®µå¤„ç†ï¼Œå°±å¯èƒ½ç”±äºåˆ†ç‰‡ä¸¢åŒ…é‡ä¼ å¯¼è‡´æ€§èƒ½åœ°ä¸‹</li>
<li>Udp æ²¡æœ‰MSSçš„æ¦‚å¿µï¼Œå…¨éƒ¨æ•°æ®ç§»äº¤ç»™ç½‘ç»œå±‚</li>
</ul>
</li>
<li>æ¥æ”¶æ–¹å¦‚ä½•é‡ç»„åˆ†æ®µåŒ…<ul>
<li>å°†IDç›¸åŒçš„åˆ†ç‰‡æŒ‰ç…§offå€¼ï¼ˆåç§»é‡ï¼‰è¿›è¡Œé‡ç»„</li>
<li>æ¥æ”¶æ–¹é€šè¿‡Flagsä¸‹é¢çš„çš„ <code>More Fragments = 0</code> åˆ¤æ–­æ˜¯ä¸æ˜¯æœ€åä¸€ä¸ªåˆ†ç‰‡ï¼Œå¦‚æœæ˜¯æœ€åä¸€ä¸ªåˆ†ç‰‡äº†ï¼Œå¯ä»¥å¼€å§‹é‡ç»„åˆ†ç‰‡äº†</li>
</ul>
</li>
</ul>
</li>
<li>Windos Scale<ul>
<li>TCPåè®®ä¸­åªç»™æ¥æ”¶çª—å£(win)é¢„ç•™äº†16ä¸ªæ¯”ç‰¹ï¼Œæ„å‘³ç€æœ€å¤§åªèƒ½è¡¨ç¤º 65535 å­—èŠ‚</li>
<li>éšç€ç½‘ç»œå¸¦å®½è¶Šæ¥è¶Šå¤§ï¼Œé¢„ç•™çš„16ä¸ªæ¯”ç‰¹å·²ç»ä¸å¤Ÿç”¨äº†ï¼ŒRFC 1323 æä¾›äº†ä¸€ä¸ªåˆ›æ„ï¼Œåœ¨ä¸‰æ¬¡æ¡æ‰‹æ—¶åŒæ–¹éƒ½æŠŠä¸€ä¸ªå« <code>Windows Scale</code> çš„å€¼å‘ŠçŸ¥å¯¹æ–¹ï¼Œå¯¹æ–¹æ”¶åˆ°åä¼šæŠŠè¿™ä¸ªå€¼å½“åš2çš„æŒ‡æ•°ï¼Œç®—å‡ºæ¥çš„å€¼å†ä½œä¸ºæ¥æ”¶çª—å£çš„ç³»æ•°</li>
<li>å‡è®¾ Windos Scale &#x3D; 3ï¼Œwin &#x3D; 10ï¼Œé‚£ä¹ˆå®é™…çš„æ¥æ”¶çª—å£ &#x3D; 10 * 2^3 &#x3D; 80</li>
<li>ï¼ï¼å¦‚æœåœ¨ä¸‰æ¬¡æ¡æ‰‹ä¹‹åæ‰å¼€å§‹æŠ“åŒ…ï¼Œå°±æ— æ³•è·å–åˆ°Windos Scaleï¼Œåªèƒ½æ˜¾ç¤ºå‡ºæ²¡æœ‰ç³»æ•°çš„å¤§å°ï¼Œè¿™æ˜¯ä¸å‡†ç¡®çš„</li>
</ul>
</li>
<li>TTL(Time to Live)<ul>
<li>TTL åˆå§‹å€¼ä¸€èˆ¬ä¸º64</li>
<li>RFC 1812 ä¸€ä¸ªç½‘ç»œåŒ…çš„TTLæ¯å‡å»1å°±æ„å‘³ç€å®ƒç»è¿‡ä¸€æ¬¡è·¯ç”±</li>
<li>TTLä¸€èˆ¬å¯ä»¥ç”¨æ¥éªŒè¯ç½‘ç»œæ‹“æ‰‘ï¼Œæ¯”å¦‚å½“å‰æ”¶åˆ°çš„åŒ…å…·ä½“æ˜¯å“ªä¸ªæœåŠ¡å™¨å‘å‡ºçš„</li>
</ul>
</li>
</ul>
<h3 id="TCP-æµé‡æ§åˆ¶ä¸çª—å£æœºåˆ¶"><a href="#TCP-æµé‡æ§åˆ¶ä¸çª—å£æœºåˆ¶" class="headerlink" title="TCP æµé‡æ§åˆ¶ä¸çª—å£æœºåˆ¶"></a>TCP æµé‡æ§åˆ¶ä¸çª—å£æœºåˆ¶</h3><ol>
<li><h4 id="TCPå¤´éƒ¨Winå­—æ®µ"><a href="#TCPå¤´éƒ¨Winå­—æ®µ" class="headerlink" title="TCPå¤´éƒ¨Winå­—æ®µ"></a>TCPå¤´éƒ¨Winå­—æ®µ</h4></li>
</ol>
<ul>
<li>Winå­—æ®µè¡¨ç¤ºå‘é€æ–¹çš„æ¥æ”¶çª—å£å¤§å°(rwnd)</li>
<li>å‘ŠçŸ¥å¯¹æ–¹è‡ªå·±è¿˜èƒ½æ¥æ”¶å¤šå°‘æ•°æ®</li>
<li>åŠ¨æ€å˜åŒ–ï¼šWin &#x3D; æ¥æ”¶ç¼“å†²åŒºå¤§å° - å·²æ¥æ”¶ä½†æœªå¤„ç†çš„æ•°æ®é‡</li>
</ul>
<h4 id="2-æµé‡æ§åˆ¶æœºåˆ¶"><a href="#2-æµé‡æ§åˆ¶æœºåˆ¶" class="headerlink" title="2.  æµé‡æ§åˆ¶æœºåˆ¶"></a>2.  æµé‡æ§åˆ¶æœºåˆ¶</h4><h5 id="2-1-æ¥æ”¶çª—å£-rwnd"><a href="#2-1-æ¥æ”¶çª—å£-rwnd" class="headerlink" title="2.1   æ¥æ”¶çª—å£(rwnd)"></a>2.1   æ¥æ”¶çª—å£(rwnd)</h5><ul>
<li>é€šè¿‡TCPå¤´éƒ¨Winå­—æ®µå‘ŠçŸ¥å¯¹æ–¹</li>
<li>åæ˜ æ¥æ”¶æ–¹çš„å¤„ç†èƒ½åŠ›</li>
<li>é˜²æ­¢æ¥æ”¶æ–¹ç¼“å†²åŒºæº¢å‡º</li>
<li>ç”±åº”ç”¨ç¨‹åºå¤„ç†é€Ÿåº¦å†³å®š</li>
</ul>
<h5 id="2-2-æ‹¥å¡çª—å£-cwnd"><a href="#2-2-æ‹¥å¡çª—å£-cwnd" class="headerlink" title="2.2  æ‹¥å¡çª—å£(cwnd)"></a>2.2  æ‹¥å¡çª—å£(cwnd)</h5><p><img data-src="/images/socket_02_11.jpeg" alt="img"></p>
<p><img data-src="/images/socket_02_12.png" alt="img"></p>
<ul>
<li>å‘é€æ–¹å†…éƒ¨ç»´æŠ¤ï¼Œä¸éœ€è¦å‘ŠçŸ¥å¯¹æ–¹</li>
<li>åæ˜ ç½‘ç»œçš„æ‰¿è½½èƒ½åŠ›</li>
<li>é˜²æ­¢ç½‘ç»œæ‹¥å¡</li>
<li>ç”±ç½‘ç»œçŠ¶å†µåŠ¨æ€è°ƒæ•´</li>
<li>æ‹¥å¡çª—å£å¯ä»¥é€šè¿‡ä¼°ç®—åœ¨é€”å­—èŠ‚æ•°è¿›è¡Œè®¡ç®—ï¼Œåœ¨é€”å­—èŠ‚æ•° &#x3D; seq + len - ackï¼Œç®€å•æ¥è¯´å°±æ˜¯å‘é€æ–¹è¿™è¾¹å‘é€è¿‡å»çš„å­—èŠ‚æ•°å‡å»å¯¹ç«¯ackçš„å­—èŠ‚æ•°å¾—åˆ°åœ¨é€”å­—èŠ‚æ•°ï¼Œé‚£ä¹ˆæ‹¥å¡çª—å£æ€ä¹ˆç¡®å®šæœ€åä¸€ä¸ªæ•°æ®åŒ…å‘¢ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªå‘ç”Ÿé‡ä¼ çš„æ•°æ®åŒ…ï¼Œæ ¹æ®æ­¤æ•°æ®åŒ…è¿›è¡Œè¿‡æ»¤ï¼Œå¾—åˆ°æœ€åä¸€ä¸ªå‘é€çš„æ•°æ®åŒ…ä»¥åŠackåŒ…ï¼Œå°±èƒ½è®¡ç®—åœ¨é€”å­—èŠ‚æ•°äº†ï¼Œå½“ç„¶è¿™ç§æ–¹å¼åªæ˜¯ä¼°ç®—ï¼Œéœ€è¦é‡‡æ ·å‡ æ¬¡ï¼Œå»æœ€ä½çš„æ‹¥å¡ç‚¹ä½œä¸ºæ‹¥å¡çª—å£</li>
</ul>
<h5 id="2-3-å®é™…å‘é€æ§åˆ¶"><a href="#2-3-å®é™…å‘é€æ§åˆ¶" class="headerlink" title="2.3 å®é™…å‘é€æ§åˆ¶"></a>2.3 å®é™…å‘é€æ§åˆ¶</h5><blockquote>
<p>å‘é€çª—å£å¤§å° &#x3D; min(å¯¹æ–¹é€šå‘Šçš„win, æœ¬åœ°çš„cwnd)</p>
</blockquote>
]]></content>
      <categories>
        <category>ç½‘ç»œ</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>ç½‘ç»œ</tag>
        <tag>tcp</tag>
        <tag>æŠ“åŒ…</tag>
      </tags>
  </entry>
</search>
