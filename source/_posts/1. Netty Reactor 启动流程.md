---
title: Netty Reactor 启动流程
tags:
  - Netty
  - 源码解析
categories:
  - Netty
abbrlink: 17349
date: 2025-02-09 15:00:22
---



## 相关链接

[详细图解Netty Reactor启动全流程 | 万字长文 | 多图预警](https://zhuanlan.zhihu.com/p/459313682)

![img](https://rq3nt70g815.feishu.cn/space/api/box/stream/download/asynccode/?code=M2RkN2M3YjVjNDQ5ZDdkMGI0OGE2Y2MwMjY0MzQ4NTRfMlhkYk5KOEp5ZGxqT1lHeWphWWtjVzRCTGIzOGgyTjNfVG9rZW46WFZWQWJxR09EbzVMekh4NHdiNmNPT2JUbnZnXzE3MzkwODQ0MjY6MTczOTA4ODAyNl9WNA)

## Netty 服务端的启动流程

- 创建服务端`NioServerSocketChannel`并初始化
- 将服务端`NioServerSocketChannel`注册到`主Reactor线程组`中
- 注册成功后，开始初始化`NioServerSocketChannel`中的 pipeline，然后在 pipeline 中触发 channelRegister 事件。
- 随后由`NioServerSocketChannel`绑定端口地址。
- 绑定端口地址成功后，向`NioServerSocketChannel`对应的`Pipeline`中触发传播`ChannelActive事件`，在`ChannelActive事件回调`中向`Main Reactor`注册`OP_ACCEPT事件`，开始等待客户端连接。服务端启动完成。

![img](https://rq3nt70g815.feishu.cn/space/api/box/stream/download/asynccode/?code=ODdjNjJhMmQwYmYzN2VmY2M4OTk4NTczZTA0ODZjMTBfd1kxMVl4ZWxiemtQcHIzRk01aDFxbHRaQU9Ud2hBZkhfVG9rZW46RGlVbGJaQUtGb2FtRkF4Zk1QbmNuaU85bmVlXzE3MzkwODQ0MjY6MTczOTA4ODAyNl9WNA)

## 1. initAndRegister

![img](https://rq3nt70g815.feishu.cn/space/api/box/stream/download/asynccode/?code=NDNlYWMzY2YzYjBiZDBjZmU5MzU2ZTMzZTAwNWQwNDhfc2g0Z0dGR0RZRUl2S2FPalB3b3Q3VUFhRUhKVnRIT2pfVG9rZW46RlJEVGJhQ2k0b2RKWGV4c01kS2M3S3dxbkRmXzE3MzkwODQ0MjY6MTczOTA4ODAyNl9WNA)

开始注册

![img](https://rq3nt70g815.feishu.cn/space/api/box/stream/download/asynccode/?code=OWVlMmQyMWM0NzgzNThjYWMyNTYwMzZlZjc1NzM2MTFfQU9DaEFWNUJIeENxYnBZMVNUYmdLZFpLUDRhR1lGTHlfVG9rZW46V1JlTWJqSFhkb1FKR1N4OFI0S2NObWJqbnlkXzE3MzkwODQ0MjY6MTczOTA4ODAyNl9WNA)

## 2. Bind

`bind事件`在 Netty 中被定义为`outbound事件`，所以它在`pipeline`中是反向传播。先从`TailContext`开始反向传播直到`HeadContext`；`bind`的核心逻辑也正是实现在`HeadContext`中

> headContext 中的绑定方法

![img](https://rq3nt70g815.feishu.cn/space/api/box/stream/download/asynccode/?code=ZGU2YWI1OWU2OGE5ZTRhMWY0ODEzYmI4ZTlmOGU3NGVfcE5lbkVzUU1lalNEWkZIUXQ1bzdvOGU3RFc2U05ZdW9fVG9rZW46RjhRSWIwR0xjbzl2RVh4TXNtMWM4WmpBbndjXzE3MzkwODQ0MjY6MTczOTA4ODAyNl9WNA)

> NioServerSocketChannel 中的绑定动作

![img](https://rq3nt70g815.feishu.cn/space/api/box/stream/download/asynccode/?code=YWNjZGZhY2UxMmJiNDJkYmI3MzQxZjhjM2FmZWEzYmNfWTlwSWVSTmFtQWVERDQ2MXJ3eENPSGh0OW4yajJPdk9fVG9rZW46TEt1SmJTOWdxb1k3OXd4d0RZeWNKMmJRbklkXzE3MzkwODQ0MjY6MTczOTA4ODAyNl9WNA)

> 绑定完成后触发 active 操作 --> HeadContext

![img](https://rq3nt70g815.feishu.cn/space/api/box/stream/download/asynccode/?code=MjBkYTExNDA4YTJlNDI1MjllM2NkNzg3MGIyZjMyODNfRGNVRzFIZmpkTUpzRnAxTGhnS3k0NUdYdHNNVFRTeUVfVG9rZW46TU5TamJMeUtWb2hRRlN4cEg3b2MwYmtQbmpkXzE3MzkwODQ0MjY6MTczOTA4ODAyNl9WNA)

> io.netty.channel.AbstractChannel.AbstractUnsafe#beginRead

![img](https://rq3nt70g815.feishu.cn/space/api/box/stream/download/asynccode/?code=N2QxNjBkZGYzNDI3N2FjZThiY2ZhYmJkMjBmMGRmZmJfVTFwbkc4RGJrU1llcVN6QUlWVUc2MUlDRlV4Y3BwMTRfVG9rZW46U04yT2I3VjRsb01IN0d4VE1jd2M2Q241bjlnXzE3MzkwODQ0MjY6MTczOTA4ODAyNl9WNA)

> io.netty.channel.nio.AbstractNioChannel#doBeginRead

![img](https://rq3nt70g815.feishu.cn/space/api/box/stream/download/asynccode/?code=YTJmNDAxY2NmZjgxMzZiOGE3YzczZDhmYmRhMjNhMTBfeHU3dTl4SUdiQ0x1RUJ2OUNneDVoazNnYWpTMHBHNVdfVG9rZW46U0t3dWJXdzg5bzJKd2J4b3dUaGNtTXREbjliXzE3MzkwODQ0MjY6MTczOTA4ODAyNl9WNA)

## 细节点

### `Reactor线程`的启动是在向`Reactor`提交第一个异步任务的时候启动的 

> io.netty.util.concurrent.SingleThreadEventExecutor#execute(java.lang.Runnable, boolean)

![img](https://rq3nt70g815.feishu.cn/space/api/box/stream/download/asynccode/?code=NWFjYzZhNDgyMDk3YmU2Y2U3ZDJjMDk1YzE0MjE2YjBfOHBSQ0xRa1pyRUFId3gwNmNIYTRXWjFUTFVLZkI0b05fVG9rZW46SWM3V2JNcVdpb1JqY1h4SzV6d2NPZWpLbjNnXzE3MzkwODQ0MjY6MTczOTA4ODAyNl9WNA)

### `Reactor`线程的核心工作 `轮询所有注册其上的Channel中的IO就绪事件`，`处理对应Channel上的IO事件`，`执行异步任务`

> io.netty.channel.nio.NioEventLoop#run

![img](https://rq3nt70g815.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTc1ZjJiYjNiNzIyNTE4ZjJiNmQ3ZDE4MjliMDcwZWJfRmtZS0liRHp0ZGVNREFkZlVSRXBheTBLNWFNTU1aNGdfVG9rZW46R29RcmJIYlgxb043bEd4S0ZkTGNBN3VKbkRjXzE3MzkwODQ0MjY6MTczOTA4ODAyNl9WNA)

### Channel 的各种事件触发顺序

1. handlerAdded


    socket 向 jdk selector 注册后、在通知注册的 promise 完成之前（也就是 promise 回调之前）触发

    ![img](https://rq3nt70g815.feishu.cn/space/api/box/stream/download/asynccode/?code=M2E3NmM0N2QzM2MwNDExMDc4OWNiYTFjYzIyMzRmODNfSnhEUTdXTkpITHRxWWlMV0VZRGFUaTl3UzhrOVdFSE1fVG9rZW46RHMyamJJU0Z1b1FMQXJ4c2JBOWNpNUtybjliXzE3MzkwODQ0MjY6MTczOTA4ODAyNl9WNA)

2. channelRegistered

    在通知 promise 完成后（也就是回调执行完成之后）会传播 Registered 事件

    ![img](https://rq3nt70g815.feishu.cn/space/api/box/stream/download/asynccode/?code=MjA5MGIxYzk4NjcwNmU1NTVkZTE4MmQ4NjQ3YzA2ZjdfUEtkQ1czdGdKVnV5VTlpRXNwVTlUcVVrYkxQYjVRc0hfVG9rZW46QkdyTmJNS0ZPb3VWNFp4c2VHeWMyYVdNbkNiXzE3MzkwODQ0MjY6MTczOTA4ODAyNl9WNA)

3. Active 

   a. 服务端 NioServerSocketChannel 判断是否激活的标准为端口是否绑定成功。

   b. 
      ```Java
      public class NioServerSocketChannel extends AbstractNioMessageChannel
                                   implements io.netty.channel.socket.ServerSocketChannel {
          @Override
          public boolean isActive() {
              return isOpen() && javaChannel().socket().isBound();
          }
      }
      ```

   c. 客户端`NioSocketChannel`判断是否激活的标准为是否处于`Connected状态`。

   d. 
      ```Java
          @Override
          public boolean isActive() {
              SocketChannel ch = javaChannel();
              return ch.isOpen() && ch.isConnected();
          }
      ```

    e. 向后传播 active 事件
    f. `readIfIsAutoRead`
    > 如果开启了自动读（io.netty.channel.ChannelConfig#isAutoRead），则注册对应感兴趣的事件
    - server 连接注册 OP_ACCEPT 事件
    - client 连接注册 OP_READ 事件

### 向底层 selector 注册

> io.netty.channel.nio.AbstractNioChannel#doRegister

![img](https://rq3nt70g815.feishu.cn/space/api/box/stream/download/asynccode/?code=ODE3MGZhZjAzZWE4ODE0ZjAzNjM2ZDY3MmM1NmY2MmRfOU1SUmU1WHVVbzFmVjg0RDNKYUcyZzZTdlBTaVpJakRfVG9rZW46SGtaSmJXSnpyb0xTQlp4aDZNb2NYMmlrbmdlXzE3MzkwODQ0MjY6MTczOTA4ODAyNl9WNA)

### NioServerSocketChannel 注册成功后回调任务进行端口绑定，会将端口绑定封装为一个任务提交到队列中，而不是即刻执行

![img](https://rq3nt70g815.feishu.cn/space/api/box/stream/download/asynccode/?code=OTBiZTI4ZjgwMjBhNjZhZTUxZDk5YmY4NDAyZTFlNzdfaWl3RUNlVjM2VDlXV01rekEycnFRSGtZc3I0bHRuRkdfVG9rZW46TVBva2JmTVdYb0F6OWF4UUI1WWNsVE9EbkliXzE3MzkwODQ0MjY6MTczOTA4ODAyNl9WNA)

### 事件在`pipeline`中的传播

- `inbound事件`从`HeadContext`开始逐个向后传播直到`TailContext`
- `outbound事件`则是反向传播，从`TailContext`开始反向向前传播直到`HeadContext`

![img](https://rq3nt70g815.feishu.cn/space/api/box/stream/download/asynccode/?code=NzgwNDg4ZDkwMjViMDI3OGM3MzJjZWY4MTYwZmFjODNfZzAxVllzZ1ZWVzJtemJ5dENZdHowVnh6VkNtUnVuaTVfVG9rZW46T0xFYmJOU1Y0b3Fnekd4N3JnZGN2cDZPbkZkXzE3MzkwODQ0MjY6MTczOTA4ODAyNl9WNA)

### 服务端 Socket 和客户端 Socket 分别在何时向 seletor 注册感兴趣的事件？

- 注册感兴趣的事件触发时机都是`ChannelActive`
  - ![img](https://rq3nt70g815.feishu.cn/space/api/box/stream/download/asynccode/?code=Y2I2ZjE5ZjU1MTM0MjdjZWI0NjNiZTFlYWViZjdjYmJfM28xa05jbEl5OFdHUnVLS3U5bnRtMzRtOTNid0E5YzFfVG9rZW46SmNma2JNT0dRb0FIQjF4VXRwTGNZMWZjbkxnXzE3MzkwODQ0MjY6MTczOTA4ODAyNl9WNA)
  - 对于服务端 socket 来说，bind 成功后会传递 `channelActive`事件
  - io.netty.channel.AbstractChannel.AbstractUnsafe#bind
  - ![img](https://rq3nt70g815.feishu.cn/space/api/box/stream/download/asynccode/?code=MjZkMzU1OGZjZGM5NWQxNzNjNzdjYjA5YjlhNzJiZDBfUEtDN3FpOXFtbzZXNTRKYWF6ZDU3Vmo0ampra3UzVUNfVG9rZW46WG1hRmJiYkxWb3M5Q0l4OEp6RGMxS003bnNmXzE3MzkwODQ0MjY6MTczOTA4ODAyNl9WNA)
  - 对于客户端 socket 来说，register 成功后会传递 `channelActive`事件
  - io.netty.channel.AbstractChannel.AbstractUnsafe#register0
  - ![img](https://rq3nt70g815.feishu.cn/space/api/box/stream/download/asynccode/?code=ZjIyOGFiNmY3MGQwOGYwZTY0OWFhYjEwMDU2NzMxYjJfMjU2UEJpb3AwdDRXUUJmZVp4STRDVXdRSDRKQkh1MEFfVG9rZW46UmE0RmJkQ09ab1o1S0h4Wm95c2MyQ3hobndDXzE3MzkwODQ0MjY6MTczOTA4ODAyNl9WNA)
- 通过 `HeadContext#read` 方法进行感兴趣事件的注册

> ```
> io.netty.channel.AbstractChannel.AbstractUnsafe#beginRead
> ```

![img](https://rq3nt70g815.feishu.cn/space/api/box/stream/download/asynccode/?code=YTBlMzQ4NTJjNzFiM2ZiNDFkZDhlMDAyNjc1MDJjN2ZfZzl5N1NUTE5YVzhkak1tOEVvS1g3aVF0aWtMRjlXOFFfVG9rZW46VnczYWJESDBGb3RWakl4OWxtMGNaemRqbkxjXzE3MzkwODQ0MjY6MTczOTA4ODAyNl9WNA)

> io.netty.channel.nio.AbstractNioChannel#doBeginRead

![img](https://rq3nt70g815.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTA0MzgyZDc2NjY4YTY3N2NjNjgxMjRkYWNjN2NhYzZfaE8zOU1tWGhMSzRYWUlwdVR6Z3pZdHVjY2lUS0k1dWpfVG9rZW46Sm1ZNmI4TnFTb0VLZGp4YTVIQmNKS0NZbnlFXzE3MzkwODQ0MjY6MTczOTA4ODAyNl9WNA)
